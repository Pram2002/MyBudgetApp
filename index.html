<!DOCTYPE html>
<html lang="fr">

<head>

    <!-- M√©tadonn√©es, polices et librairies externes -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Budget S√©curis√©</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>

        /* 
         * --- SECTION CSS ---
         * Variables (:root) pour d√©finir la palette de couleurs
         * Utilisation des classes pour styliser les diff√©rents composants de l'interface (boutons, cartes, tableaux, modales ...)
         * L'utilisation de `display: grid` et `display: flex` rend le design "responsive" (adaptatif)
        */

        :root {
            --primary-color: #0D47A1;      
            --primary-color-dark: #002171; 
            --secondary-color: #6c757d;    
            --secondary-color-dark: #495057; 
            --success-color: #198754;      
            --danger-color: #dc3545;       
            --warning-color: #ffc107;      
            --info-color: #0dcaf0;         
            --light-bg-color: #e7f0fe;     
            --text-color: #212529;         
            --text-color-light: #6c757d;   
            --border-color: #dee2e6;       
            --card-shadow: 0 4px 12px rgba(0,0,0,0.06);
            --border-radius: 12px;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--light-bg-color); 
            color: var(--text-color); 
            line-height: 1.6; 
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 24px; 
        }

        /* --- LOGIN SCREEN --- */
        .login-screen { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
        }
        .login-form { 
            background: white; 
            padding: 40px; 
            border-radius: var(--border-radius); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            text-align: center; 
            min-width: 380px; 
        }
        .login-form h1 { 
            color: var(--primary-color); 
            margin-bottom: 30px; 
            font-weight: 700; 
        }
        .login-form input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s; 
        }
        .login-form input:focus { 
            outline: none; 
            border-color: var(--primary-color); 
        }
        .login-btn { 
            width: 100%; 
            padding: 12px; 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.3s; 
            margin: 5px 0; 
        }
        .login-btn:hover { 
            background: var(--primary-color-dark); 
        }
        .file-input { 
            display: none; 
        }
        .file-label { 
            display: inline-block; 
            width: 100%; 
            padding: 12px; 
            background: var(--success-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.3s; 
            margin: 5px 0; 
            text-align: center; 
        }
        .file-label:hover { 
            background: #157347; 
        }
        .login-options { 
            margin: 20px 0; 
            padding: 20px 0; 
            border-top: 1px solid var(--border-color); 
        }
        .login-options h3 { 
            margin-bottom: 15px; 
            color: var(--text-color-light); 
            font-size: 16px; 
        }

        /* --- HEADER --- */
        .header { 
            background: white; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            margin-bottom: 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        .logo { 
            font-size: 24px; 
            font-weight: 700; 
            color: var(--primary-color); 
        }
        .header-actions { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
            font-size: 14px; 
        }
        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
        }
        .btn-primary:hover { 
            background: var(--primary-color-dark); 
        }
        .btn-success { 
            background: var(--success-color); 
            color: white; 
        }
        .btn-success:hover { 
            background: #157347; 
        }
        .btn-danger { 
            background: var(--danger-color); 
            color: white; 
        }
        .btn-danger:hover { 
            background: #b02a37; 
        }
        .btn-secondary { 
            background: var(--secondary-color); 
            color: white; 
        }
        .btn-secondary:hover { 
            background: var(--secondary-color-dark); 
        }
        .btn-warning { 
            background: var(--warning-color); 
            color: black; 
        }
        .btn-warning:hover { 
            background: #ffca2c; 
        }
        .btn-info { 
            background: var(--info-color); 
            color: black; 
        }
        .btn-info:hover { 
            background: #31d2f2; 
        }

        /* --- DASHBOARD --- */
        .dashboard-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; margin-bottom: 24px; 
        }
        .summary-card { 
            background: white; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            border-left: 5px solid; 
        }
        .summary-card h4 { 
            font-size: 14px; 
            color: var(--text-color-light); 
            margin-bottom: 8px; 
            font-weight: 500; 
        }
        .summary-card p { 
            font-size: 24px; 
            font-weight: 700; 
        }
        .summary-card.income { 
            border-left-color: var(--success-color); 
        }
        .summary-card.expense { 
            border-left-color: var(--danger-color); 
        }
        .summary-card.balance { 
            border-left-color: var(--primary-color); 
        }
        .summary-card.savings { 
            border-left-color: var(--info-color); 
        }

        /* --- YEAR TABS --- */
        .year-tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 24px; 
            overflow-x: auto; 
            padding-bottom: 10px; 
        }
        .year-tab { 
            padding: 12px 20px; 
            background: white; 
            border: 2px solid var(--border-color); 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 600; 
            white-space: nowrap; 
            transition: all 0.3s; 
        }
        .year-tab.active { 
            background: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
        }
        .year-tab:hover:not(.active) { 
            border-color: var(--primary-color); 
            color: var(--primary-color); 
            background: #e7f0fe; 
        }

        /* --- MAIN CONTENT & TABLE --- */
        .main-content { 
            background: white; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            padding: 24px; 
        }
        .table-container { 
            overflow-x: auto; 
            max-height: 70vh; 
            margin-bottom: 20px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
        }
        .financial-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1400px; 
        }
        .financial-table th { 
            background: var(--primary-color); 
            color: white; 
            padding: 15px 10px; 
            text-align: center; 
            font-weight: 600; 
            border: 1px solid #002171; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        .financial-table td { 
            padding: 8px 10px; 
            border: 1px solid var(--border-color); 
            text-align: left; 
            vertical-align: top; 
            font-size: 14px; 
            position: relative; 
        }
        .financial-table tr:nth-child(even) { 
            background: #f8f9fa; 
        }
        .financial-table tr.subsection-row:hover { 
            background: #e9ecef; 
        }
        .account-header { 
            background: var(--primary-color-dark) !important; 
            font-weight: 700; 
            color: white; 
        }
        .section-header { 
            background: #d4e3ff !important; 
            font-weight: 600; 
            text-align: left !important; 
            padding-left: 20px !important; 
            color: var(--primary-color); 
        }
        .action-item { 
            cursor: pointer; 
            padding: 4px 8px; 
            border-radius: 16px; 
            margin-bottom: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 8px; 
            background-color: #e9ecef; 
            transition: background-color 0.2s; 
            border: 1px solid #ced4da; 
        }
        .action-item:hover { 
            background-color: #ced4da; 
        }
        .action-item.projected { 
            background-color: #fff8e1; 
            border: 1px dashed #ffd54f; 
        }
        .action-item.projected:hover { 
            background-color: #ffecb3; 
        }
        .action-item span:first-child { 
            flex-grow: 1; 
            max-width: 100px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            font-size: 13px; 
        }
        .quick-add-btn { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            border: none; 
            background-color: var(--primary-color); 
            color: white; font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            opacity: 0; 
            transition: opacity 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .financial-table td:hover .quick-add-btn { 
            opacity: 0.8; 
        }
        .amount-positive { 
            color: var(--success-color); 
            font-weight: 600; 
        }
        .amount-negative { 
            color: var(--danger-color); 
            font-weight: 600; 
        }
        .section-total-row td { 
            background: #e9ecef !important; 
            font-weight: 700; 
            text-align: right; 
            color: var(--text-color); 
            vertical-align: middle; 
        }
        .section-total-row td:first-child { 
            text-align: left; 
        }
        .balance-row td { 
            background: #f8f9fa !important; 
            font-weight: 700; 
            border-top: 2px solid var(--primary-color) !important; 
            text-align: right; 
        }
        .balance-row td:first-child { 
            text-align: left; 
        }
        .grand-total-balance-row td { 
            background-color: #d4e3ff !important; 
            font-weight: 700; 
            font-size: 16px !important; 
            border-top: 3px solid var(--primary-color-dark) !important; 
            text-align: right; 
        }
        .grand-total-balance-row td:first-child { 
            text-align: left; 
        }

        /* --- MODAL & FORMS --- */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            overflow-y: auto; 
            padding: 40px 0; 
        }
        .modal-content { 
            background: white; 
            margin: 0 auto; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            width: 90%; 
            max-width: 900px; 
        }
        .modal-content-large { 
            max-width: 1400px; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--border-color); 
        }
        .close { 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
            color: #999; 
        }
        .close:hover { 
            color: #333; 
        }
        .form-container { 
            background: var(--light-bg-color); 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid var(--border-color); 
        }
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: var(--text-color); 
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 14px; 
            transition: border-color 0.3s; 
            background-color: white; 
        }
        .form-group input:focus, .form-group select:focus { 
            outline: none; 
            border-color: var(--primary-color); 
        }

        /* --- IMPROVED LAYOUTS --- */
        .card-style {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 15px;
        }

        /* STARTING BALANCES */
        .starting-balance-form { 
            background: transparent; 
            border: none; 
            padding: 0; 
        }
        .balance-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        }
        .balance-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .balance-item label { 
            font-weight: 600; 
            color: var(--text-color); 
        }
        .balance-item input { 
            width: 120px; 
            padding: 8px; 
            border: 2px solid var(--border-color); 
            border-radius: 6px; 
            text-align: right; 
        }
        .balance-item input:focus { 
            outline: none; 
            border-color: var(--primary-color); 
        }

        /* STRUCTURE, RECURRENTS */
        .structure-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
        } 
        .structure-item-name { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-grow: 1; 
            font-weight: 500; 
        }
        .icon-input { 
            width: 40px !important; 
            text-align: center; 
            padding: 5px !important; 
            font-size: 18px !important; 
        }
        .structure-item.section { 
            border-left-color: #42A5F5; 
            margin-left: 20px; 
        }
        .structure-item.subsection { 
            border-left-color: #90CAF9; 
            margin-left: 40px; 
        }
        .structure-actions { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }

        /* BUDGETS */
        .budget-account-title { 
            font-size: 1.5rem; 
            color: var(--primary-color); 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 8px; 
            margin-bottom: 20px; 
        }
        .budget-section-title { 
            font-size: 1.2rem; 
            font-weight: 600; 
            margin-bottom: 15px; 
            padding-left: 5px; 
        }
        .budget-card { 
            margin-left: 20px; 
        }
        .budget-card h4 { 
            margin-bottom: 15px; 
            font-weight: 600; 
        }
        .budget-period { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 14px; 
            background: #f8f9fa; 
            padding: 8px 12px; 
            border-radius: 8px; 
            margin-bottom: 8px; 
        }
        .budget-form { 
            background: #f1f3f5; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 15px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        
        .hidden { 
            display: none; 
        }
        .auto-save-indicator { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--success-color); 
            color: white; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
            opacity: 0; 
            transition: opacity 0.3s; 
            z-index: 1001; 
        }
        .auto-save-indicator.show { 
            opacity: 1; 
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { flex-direction: column; gap: 15px; }
            .form-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; margin: 20px auto; padding: 20px; }
            .login-form { min-width: 300px; padding: 30px; }
            .dashboard-summary { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>

    <!-- 
      * --- SECTION HTML ---
      * Le HTML est divis√© en blocs logiques :
      * 1. Auto Save Indicator : Un petit message qui appara√Æt lors de la sauvegarde
      * 2. Login Screen : L'√©cran de connexion, visible au d√©but
      * 3. Main App : Le conteneur principal de l'application, cach√© au d√©but
      * 4. Modales (Stats Modal, Action Modal, ...) : Des fen√™tres pop-up pour les formulaires et les statistiques. Elles sont cach√©es par d√©faut (display: none) et affich√©es via JavaScript
    -->

    <!-- 1. Auto Save Indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">
        üíæ Donn√©es Enregistr√©es
    </div>

    <!-- 2. Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-form">
            <h1>üîí Mon Budget S√©curis√©</h1>
            <p style="margin-bottom: 20px; font-size: 14px; color: var(--text-color-light);">Toutes les donn√©es sont maintenant chiffr√©es.</p>
            <div>
                <input type="password" id="passwordInput" placeholder="Entrez votre mot de passe" />
                <button class="login-btn" onclick="login()">Acc√©der au Registre</button>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    Premi√®re visite ? Votre mot de passe sera d√©fini et utilis√© pour chiffrer vos donn√©es.
                </p>
            </div>
            <div class="login-options">
                <h3>Charger des Donn√©es Existantes</h3>
                <input type="file" id="dataFileInput" accept=".json" class="file-input" onchange="loadDataFile()">
                <label for="dataFileInput" class="file-label">üìÅ Charger un Fichier de Donn√©es</label>
                <button id="restoreBtn" class="login-btn btn-warning" onclick="restoreFromBackup()" style="display:none; margin-top: 10px;">üîÑ Restaurer Version Pr√©c√©dente</button>
            </div>
        </div>
    </div>

    <!-- 3. Main App -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <!-- Header avec le logo et les boutons d'action principaux -->
            <div class="header">
                <div class="logo">üîí Mon Budget</div>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="saveDataFile()">üíæ Sauvegarder</button>
                    <button class="btn btn-primary" onclick="showStats()">üìä Statistiques</button>
                    <button class="btn btn-primary" onclick="showRecurrentModal()">üîÑ G√©rer R√©currences</button>
                    <button class="btn btn-primary" onclick="showBudgetManager()">üí∞ G√©rer les Budgets</button>
                    <button class="btn btn-primary" onclick="showStructureManager()">‚öôÔ∏è G√©rer la Structure</button>
                    <button class="btn btn-info" onclick="showProjectionModal()">üîÆ Projection 2 Ans</button>
                    <button class="btn btn-secondary" onclick="logout()">üö™ D√©connexion</button>
                </div>
            </div>

            <!-- Onglets pour naviguer entre les ann√©es -->
            <div class="year-tabs" id="yearTabs"></div>
            
            <div class="main-content">
                <!-- Cartes de r√©sum√© (dashboard) -->
                <div id="dashboardSummary" class="dashboard-summary"></div>

                <!-- Formulaire pour les soldes initiaux -->
                <div class="starting-balance-form">
                    <h3>üí∞ Soldes Initiaux des Comptes pour <span id="balanceYear"></span></h3>
                    <div class="balance-grid" id="balanceGrid"></div>
                </div>

                <!-- Boutons d'action pour la table principale -->
                <div style="margin: 20px 0; display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="btn btn-primary" onclick="showAddActionForm()">+ Ajouter Op√©ration</button>
                    <button class="btn btn-primary" onclick="showTransferModal()" style="background-color: #5C6BC0;">Virement Inter-compte</button>
                    <button class="btn btn-success" onclick="addNewYear()">+ Ajouter Ann√©e</button>
                    <button class="btn btn-danger" onclick="deleteCurrentYear()">- Supprimer Ann√©e</button>
                    <button class="btn btn-secondary" onclick="collapseAll()">Tout R√©duire</button>
                    <button class="btn btn-secondary" onclick="expandAll()">Tout D√©velopper</button>
                </div>

                <!-- Le conteneur pour la table financi√®re principale -->
                <div class="table-container">
                    <table class="financial-table" id="financialTable"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Modales -->
    <!-- Chaque modale a une structure similaire : un conteneur, un contenu, un en-t√™te avec un titre et un bouton de fermeture. -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="stats-modal-title">Statistiques Financi√®res</h2>
                <span class="close" onclick="closeModal('statsModal')">√ó</span>
            </div>
            <div id="statsContent"></div>
        </div>
    </div>
    <div id="structureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>G√©rer la Structure</h2>
                <span class="close" onclick="closeModal('structureModal')">√ó</span>
            </div>
            <div id="structureContent"></div>
        </div>
    </div>
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>G√©rer les Budgets</h2>
                <span class="close" onclick="closeModal('budgetModal')">√ó</span>
            </div>
            <div id="budgetManagerContent"></div>
        </div>
    </div>
    
    <!-- Modale pour ajouter/modifier une op√©ration -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="formTitle">Ajouter une Nouvelle Op√©ration</h2>
                <span class="close" onclick="closeModal('actionModal')">√ó</span>
            </div>
            <div class="add-action-form form-container">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom de l'Op√©ration</label>
                        <input type="text" id="actionName" placeholder="Ex: Courses, Restaurant...">
                    </div>
                    <div class="form-group">
                        <label>Compte</label>
                        <select id="actionAccount" onchange="populateSections(); adjustAmountSign();"></select>
                    </div>
                    <div class="form-group">
                        <label>Section</label>
                        <select id="actionSection" onchange="populateSubsections(); adjustAmountSign();"></select>
                    </div>
                    <div class="form-group">
                        <label>Sous-section</label>
                        <select id="actionSubsection" onchange="adjustAmountSign()"></select>
                    </div>
                    <div class="form-group">
                        <label>Mois</label>
                        <select id="actionMonth">
                            <option value="0">Janvier</option>
                            <option value="1">F√©vrier</option>
                            <option value="2">Mars</option>
                            <option value="3">Avril</option>
                            <option value="4">Mai</option>
                            <option value="5">Juin</option>
                            <option value="6">Juillet</option>
                            <option value="7">Ao√ªt</option>
                            <option value="8">Septembre</option>
                            <option value="9">Octobre</option>
                            <option value="10">Novembre</option>
                            <option value="11">D√©cembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Montant</label>
                        <input type="number" id="actionAmount" placeholder="Montant" step="0.01" onblur="adjustAmountSign()">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="actionType">
                            <option value="actual">R√©el</option>
                            <option value="projected">Projet√©</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="addOrUpdateButton" class="btn btn-primary" onclick="addAction()">Ajouter l'Op√©ration</button>
                    <button class="btn btn-danger" id="deleteActionButton" onclick="deleteAction()" style="display: none;">Supprimer l'Op√©ration</button>
                    <button class="btn btn-secondary" onclick="closeModal('actionModal')">Annuler</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modale pour les virements -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="transferModalTitle">Effectuer un Virement Inter-compte</h2>
                <span class="close" onclick="closeModal('transferModal')">√ó</span>
            </div>
            <div class="transfer-form form-container">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom du virement</label>
                        <input type="text" id="transferName" placeholder="Ex: √âpargne mensuelle">
                    </div>
                    <div class="form-group">
                        <label>Compte √† D√©biter</label>
                        <select id="transferSourceAccount"></select>
                    </div>
                    <div class="form-group">
                        <label>Compte √† Cr√©diter</label>
                        <select id="transferDestAccount"></select>
                    </div>
                    <div class="form-group">
                        <label>Mois</label>
                        <select id="transferMonth">
                            <option value="0">Janvier</option>
                            <option value="1">F√©vrier</option>
                            <option value="2">Mars</option>
                            <option value="3">Avril</option>
                            <option value="4">Mai</option>
                            <option value="5">Juin</option>
                            <option value="6">Juillet</option>
                            <option value="7">Ao√ªt</option>
                            <option value="8">Septembre</option>
                            <option value="9">Octobre</option>
                            <option value="10">Novembre</option>
                            <option value="11">D√©cembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Somme</label>
                        <input type="number" id="transferAmount" placeholder="Montant du virement" step="0.01">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="addOrUpdateTransferButton" onclick="addTransfer()">Effectuer le Virement</button>
                    <button class="btn btn-danger" id="deleteTransferButton" onclick="deleteTransfer()" style="display: none;">Supprimer le Virement</button>
                    <button class="btn btn-secondary" onclick="closeModal('transferModal')">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale pour les op√©rations r√©currentes -->
    <div id="recurrentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>G√©rer les Op√©rations R√©currentes</h2>
                <span class="close" onclick="closeModal('recurrentModal')">√ó</span>
            </div>
            <p style="margin-bottom:20px; font-style:italic;">Ces op√©rations seront automatiquement ajout√©es pour chaque mois de l'ann√©e en cours.</p>
            <div class="recurrent-form form-container">
                <h3 id="recurrentFormTitle">Ajouter une Op√©ration R√©currente</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" id="recurrentName" placeholder="Ex: Loyer, Netflix...">
                    </div>
                    <div class="form-group">
                        <label>Compte</label>
                        <select id="recurrentAccount"></select>
                    </div>
                    <div class="form-group">
                        <label>Section</label>
                        <select id="recurrentSection"></select>
                    </div>
                    <div class="form-group">
                        <label>Sous-section</label>
                        <select id="recurrentSubsection"></select>
                    </div>
                    <div class="form-group">
                        <label>Montant Mensuel</label>
                        <input type="number" id="recurrentAmount" placeholder="Montant" step="0.01" onblur="adjustAmountSign('recurrent')">
                    </div>
                    <div class="form-group">
                        <label>Date de d√©but (AAAA-MM)</label>
                        <input type="month" id="recurrentStartDate">
                    </div>
                    <div class="form-group">
                        <label>Date de fin (AAAA-MM)</label>
                        <input type="month" id="recurrentEndDate">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="recurrentType">
                            <option value="projected">Projet√© (Auto)</option>
                            <option value="actual">R√©el</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="addOrUpdateRecurrentButton" class="btn btn-primary" onclick="saveRecurrentTransaction()">Ajouter</button>
                    <button class="btn btn-secondary" onclick="clearRecurrentForm()">Annuler</button>
                </div>
            </div>
            <div id="recurrentList" style="margin-top: 30px;"></div>
        </div>
    </div>

    <!-- Modale pour la projection -->
    <div id="projectionModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Projection sur 2 Ans</h2>
                <span class="close" onclick="closeModal('projectionModal')">√ó</span>
            </div>
            <div id="projectionContent">
                <!-- Le contenu sera g√©n√©r√© par JavaScript -->
            </div>
        </div>
    </div>

    <script>

        // --- GLOBAL VARIABLES & CONSTANTS ---

        /**
         * 'appData' est l'objet central qui contient TOUT l'√©tat de l'application
         * Il est modifi√© par les actions de l'utilisateur et utilis√© pour afficher l'interface
         * Le sauvegarder et le charger revient √† sauvegarder/charger toute l'application.
        */
        let appData = { 
            password: null,              // Le mot de passe utilis√© pour chiffrer/d√©chiffrer 
            years: {},                   // Un objet o√π chaque cl√© est une ann√©e (ex: "2023")
            currentYear: new Date().getFullYear(), // L'ann√©e actuellement affich√©e
            editingAction: null,         // Garde en m√©moire l'ID de l'op√©ration en cours d'√©dition
            editingRecurrent: null,      // Garde en m√©moire l'ID de la r√©currence en cours d'√©dition 
            editingTransferId: null      // Garde en m√©moire l'ID du virement en cours d'√©dition
        };

        /**
         * 'uiState' stocke l'√©tat de l'interface qui n'a pas besoin d'√™tre sauvegard√©, comme savoir quelles sections sont ouvertes ou ferm√©es
        */
        let uiState = { collapsed: {} };
        let structureUiState = { collapsed: {} }; // √âtat pour la modale de structure

        // Constantes pour les mois, pour √©viter les "cha√Ænes magiques" dans le code
        const months = ['Janv', 'F√©vr', 'Mars', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sept', 'Oct', 'Nov', 'D√©c'];
        const fullMonths = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

        // Constantes pour les virements internes, pour √©viter les erreurs de frappe
        const VIREMENT_SECTION_ID = 'internal_transfers';
        const VIREMENT_SECTION_NAME = 'Virements Inter-comptes';


        // --- CORE APP LOGIC & ENCRYPTION ---

        /**
         * Initialise l'application au chargement de la page
         * Cr√©e les donn√©es pour l'ann√©e en cours si elles n'existent pas
         * V√©rifie s'il existe une sauvegarde de session pour proposer la restauration
        */
        function init() {
            if (!appData.years[appData.currentYear]) {
                appData.years[appData.currentYear] = createNewYearData();
            }
            // V√©rifie si une sauvegarde locale existe (par exemple, d'une session pr√©c√©dente non sauvegard√©e)
            if (localStorage.getItem('budgetAppBackup')) {
                document.getElementById('restoreBtn').style.display = 'inline-block';
            }
        }

        /**
         * Cr√©e un objet de donn√©es vide pour une nouvelle ann√©e
         * @param {object} [structureToCopy=null] - Si fourni, copie la structure (comptes/cat√©gories) d'une ann√©e existante
         * @returns {object} Un objet de donn√©es vierge pour une ann√©e
        */
        function createNewYearData(structureToCopy = null) {
            // Structure par d√©faut si c'est la toute premi√®re utilisation
            const defaultStructure = {
                accounts: [{ id: 'account1', name: 'Compte Principal', sections: [
                    { id: 'income', name: 'Revenus', icon: 'üí∞', categoryType: 'income', subsections: [ { id: 'salary', name: 'Salaire', icon: 'üíº', categoryType: 'income', budgets: [] } ]},
                    { id: 'expenses', name: 'D√©penses', icon: 'üí∏', categoryType: 'expense', subsections: [ { id: 'rent', name: 'Loyer', icon: 'üè†', categoryType: 'expense', budgets: [] }, { id: 'food', name: 'Nourriture', icon: 'üõí', categoryType: 'expense', budgets: [] } ]}
                ]}]
            };
            // Si une structure est fournie, on la copie pour la nouvelle ann√©e
            if (structureToCopy) {
                // `JSON.parse(JSON.stringify(...))` est une astuce pour faire une copie profonde de l'objet
                let newStructure = JSON.parse(JSON.stringify(structureToCopy));
                // On r√©initialise les budgets pour la nouvelle ann√©e
                newStructure.accounts.forEach(acc => acc.sections.forEach(sec => sec.subsections.forEach(sub => sub.budgets = [])));
                return { actual: {}, projected: {}, startingBalances: {}, recurrentTransactions: [], structure: newStructure };
            }
            // Sinon, on retourne la structure par d√©faut
            return { actual: {}, projected: {}, startingBalances: {}, recurrentTransactions: [], structure: defaultStructure };
        }
        
        /**
         * Cr√©e une sauvegarde chiffr√©e des donn√©es actuelles dans le localStorage du navigateur
         * C'est une s√©curit√© en cas de fermeture accidentelle de l'onglet avant de sauvegarder le fichier
        */
        function createBackup() {
            if (!appData.password || !appData.years) return; // Ne fait rien s'il n'y a pas de mot de passe
            try {
                // Chiffre les donn√©es avec CryptoJS et le mot de passe actuel
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify({ years: appData.years }), appData.password).toString();
                // Stocke la cha√Æne chiffr√©e dans le localStorage
                localStorage.setItem('budgetAppBackup', encrypted);
                console.log("Backup de session cr√©√© dans localStorage.");
            } catch (err) {
                console.error("Erreur lors de la cr√©ation du backup de session:", err);
            }
        }
        
        /**
         * Restaure les donn√©es √† partir de la sauvegarde stock√©e dans le localStorage
        */
        function restoreFromBackup() {
            const encryptedBackup = localStorage.getItem('budgetAppBackup');
            if (!encryptedBackup) return alert("Aucun backup de session trouv√©.");
            const p = prompt('Entrez le mot de passe pour restaurer la version pr√©c√©dente :');
            if (!p) return; // L'utilisateur a annul√©
            try {
                // Tente de d√©chiffrer les donn√©es du backup avec le mot de passe fourni
                const decryptedDataString = CryptoJS.AES.decrypt(encryptedBackup, p).toString(CryptoJS.enc.Utf8);
                if (!decryptedDataString) throw new Error("Decryption failed. Wrong password?");
                // Remplace les donn√©es actuelles par celles du backup
                appData.years = migrateData(JSON.parse(decryptedDataString)).years;
                appData.password = p;
                showMainApp();
                alert('Donn√©es de la session pr√©c√©dente restaur√©es avec succ√®s !');
            } catch (err) {
                console.error("Erreur lors de la restauration du backup :", err);
                alert('Erreur: Mot de passe incorrect ou backup corrompu.');
            }
        }

        /**
         * Chiffre les donn√©es actuelles et d√©clenche le t√©l√©chargement d'un fichier .json.
        */
        function saveDataFile() {
            if (!appData.password) { alert("Erreur : Aucun mot de passe n'est d√©fini pour chiffrer les donn√©es."); return; }
            // Cr√©e un backup local avant de t√©l√©charger, par s√©curit√©
            createBackup();
            document.getElementById('restoreBtn').style.display = 'inline-block';
            try {
                // Chiffre les donn√©es (l'objet `appData.years`)
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify({ years: appData.years }), appData.password).toString();
                // Cr√©e un "Blob", qui est un objet de type fichier en m√©moire
                const b = new Blob([JSON.stringify({ encryptedData: encrypted }, null, 2)], { type: 'application/json' });
                // Cr√©e une URL pour ce Blob
                const u = URL.createObjectURL(b);
                // Cr√©e un lien <a> invisible, le configure et simule un clic pour t√©l√©charger le fichier
                const a = document.createElement('a');
                a.href = u;
                a.download = `mon-budget-sauvegarde-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                // Lib√®re l'URL de la m√©moire
                URL.revokeObjectURL(u);
                showAutoSaveIndicator();
            } catch (err) { console.error("Erreur de chiffrement:", err); alert("Une erreur est survenue lors du chiffrement des donn√©es."); }
        }

        /**
         * G√®re la lecture et le d√©chiffrement d'un fichier de donn√©es s√©lectionn√© par l'utilisateur
        */
        function loadDataFile() {
            const f = document.getElementById('dataFileInput').files[0]; if (!f) return;
            const r = new FileReader(); // Utilise l'API FileReader pour lire le contenu du fichier
            r.onload = (e) => { // 'onload' est appel√© quand la lecture est termin√©e
                const p = prompt('Entrez le mot de passe pour ce fichier de donn√©es :'); if (!p) return;
                try {
                    const fileContent = JSON.parse(e.target.result);
                    let decryptedDataString;
                    // Le fichier contient-il un champ 'encryptedData' ?
                    if (fileContent.encryptedData) {
                        // Si oui, on le d√©chiffre
                        decryptedDataString = CryptoJS.AES.decrypt(fileContent.encryptedData, p).toString(CryptoJS.enc.Utf8);
                        if (!decryptedDataString) throw new Error("Decryption failed. Wrong password?");
                    } else {
                        // Compatibilit√© avec d'anciennes versions non chiffr√©es
                        console.warn("Chargement d'un fichier non-chiffr√©. Il sera chiffr√© √† la prochaine sauvegarde.");
                        decryptedDataString = JSON.stringify(fileContent);
                    }
                    // Met √† jour 'appData' avec les donn√©es charg√©es et migr√©es si n√©cessaire
                    appData.years = migrateData(JSON.parse(decryptedDataString)).years;
                    appData.password = p;
                    showMainApp();
                    alert('Donn√©es charg√©es avec succ√®s !');
                } catch (err) { console.error("Erreur lors de la lecture/d√©chiffrement du fichier :", err); alert('Erreur: Mot de passe incorrect ou fichier corrompu.'); }
            };
            r.readAsText(f); // Lance la lecture du fichier
        }
        
        /**
         * G√®re la logique de connexion
         * Si c'est la premi√®re fois, le mot de passe est simplement enregistr√© dans `appData`
        */
        function login() { 
            const p = document.getElementById('passwordInput').value; 
            if (!p) return alert('Veuillez entrer un mot de passe'); 
            if (!appData.password) { 
                appData.password = p; showMainApp(); 
                alert('Mot de passe d√©fini ! Pensez √† sauvegarder votre fichier pour l\'enregistrer de mani√®re chiffr√©e.'); 
            } 
        }

        /**
         * Affiche l'application principale et cache l'√©cran de connexion
         * C'est le point d'entr√©e apr√®s une connexion r√©ussie ou le chargement de donn√©es
        */
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            // Assure que l'ann√©e actuelle existe dans les donn√©es
            if (!appData.years[appData.currentYear]) {
                appData.currentYear = Object.keys(appData.years).sort((a, b) => b - a)[0] || new Date().getFullYear();
                if (!appData.years[appData.currentYear]) { appData.years[appData.currentYear] = createNewYearData(); }
            }
            resetUiState(); 
            applyRecurrentTransactions(); // Applique les r√®gles de r√©currence
            renderAll(); // Redessine toute l'interface
        }

        /**
         * Fonction "chef d'orchestre" qui appelle toutes les fonctions de rendu pour mettre √† jour l'UI
        */
        function renderAll() { 
            renderDashboardSummary(); 
            renderYearTabs(); 
            renderTable(); 
            renderStartingBalances(); 
            populateFormDropdowns(); // Pr√©-remplit les menus d√©roulants des formulaires
        }
        
        function migrateData(data) {
            if (data.structure) { 
                Object.keys(data.years).forEach(year => { if (!data.years[year].structure) { data.years[year].structure = JSON.parse(JSON.stringify(data.structure)); } }); 
                delete data.structure; 
            }
            Object.keys(data.years).forEach(year => {
                const yearData = data.years[year]; 
                if (!yearData.structure) return;
                yearData.structure = migrateStructureToArrayFormat(yearData.structure);
                yearData.structure.accounts.forEach(acc => acc.sections.forEach(sec => {
                    if (sec.icon === undefined) sec.icon = '';
                    if (sec.categoryType === undefined) { sec.categoryType = (sec.name.toLowerCase().includes('revenu') || sec.id.toLowerCase().includes('income')) ? 'income' : 'expense'; }
                    sec.subsections.forEach(sub => {
                        if (sub.icon === undefined) sub.icon = '';
                        if (sub.budget !== undefined) { sub.budgets = sub.budget > 0 ? [{ amount: sub.budget, startMonth: 0, endMonth: 11 }] : []; delete sub.budget; }
                        if (sub.categoryType === undefined) { sub.categoryType = sec.categoryType; }
                        if (!sub.budgets) sub.budgets = [];
                    });
                }));
                if (!yearData.recurrentTransactions) { yearData.recurrentTransactions = []; }
            });
            return data;
        }

        function migrateStructureToArrayFormat(structure) {
            if (!structure || (structure.accounts && Array.isArray(structure.accounts))) { return structure; }
            return { accounts: Object.keys(structure.accounts).map(accId => {
                const account = structure.accounts[accId];
                return { id: accId, name: account.name, sections: Object.keys(account.sections).map(secId => {
                    const section = account.sections[secId];
                    return { id: secId, name: section.name, icon: '', subsections: Object.keys(section.subsections).map(subId => ({ id: subId, name: section.subsections[subId].name, icon: '', budgets: [], categoryType: 'expense' })), categoryType: 'expense' };
                })};
            })};
        }
        
        function logout() { 
            if (confirm('Voulez-vous sauvegarder vos donn√©es (chiffr√©es) avant de vous d√©connecter ?')) { saveDataFile(); } 
            appData = { password: null, years: {}, currentYear: new Date().getFullYear(), editingAction: null, editingRecurrent: null, editingTransferId: null }; 
            init(); 
            document.getElementById('loginScreen').classList.remove('hidden'); 
            document.getElementById('mainApp').classList.add('hidden'); 
            document.getElementById('passwordInput').value = ''; document.getElementById('dataFileInput').value = ''; 
        }

        function showAutoSaveIndicator() { 
            const i = document.getElementById('autoSaveIndicator'); 
            i.classList.add('show'); setTimeout(() => i.classList.remove('show'), 2000); 
        }

        function getCurrentStructure() { 
            return appData.years[appData.currentYear]?.structure; 
        }
        
        function resetUiState() { 
            uiState.collapsed = {}; 
        }

        function getActionsForCurrentYear() { 
            const d = appData.years[appData.currentYear] || { actual: {}, projected: {} }; 
            const a = []; 
            ['actual', 'projected'].forEach(t => { Object.values(d[t] || {}).forEach(ac => a.push({ ...ac, type: t })); }); 
            return a; 
        }

        function getActualActionsForCurrentYear() { 
            const d = appData.years[appData.currentYear]; 
            if (!d || !d.actual) return []; 
            return Object.values(d.actual).map(a => ({ ...a, type: 'actual' })); 
        }


        // --- UI & TABLE RENDERING ---
        
        /**
         * Met √† jour les 4 cartes de r√©sum√© en haut de la page (revenus, d√©penses, ...) pour le mois en cours
        */
        function renderDashboardSummary() {
            const summaryDiv = document.getElementById('dashboardSummary');
            const currentMonth = new Date().getMonth();
            const actions = getActualActionsForCurrentYear();
            let income = 0;
            let expenses = 0;
            actions.forEach(action => {
                if (action.isTransfer) return;
                const amount = action.months[currentMonth] || 0;
                if (amount > 0) {
                    income += amount;
                } else {
                    expenses += Math.abs(amount);
                }
            });
            const balance = income - expenses;
            const savingsRate = income > 0 ? ((balance / income) * 100).toFixed(1) : 0;
            summaryDiv.innerHTML = `
                <div class="summary-card income">
                    <h4>Revenus du Mois</h4>
                    <p class="amount-positive">+ ${income.toFixed(2)} ‚Ç¨</p>
                </div>
                <div class="summary-card expense">
                    <h4>D√©penses du Mois</h4>
                    <p class="amount-negative">- ${expenses.toFixed(2)} ‚Ç¨</p>
                </div>
                <div class="summary-card balance">
                    <h4>Solde du Mois</h4>
                    <p class="${balance >= 0 ? 'amount-positive' : 'amount-negative'}">${balance.toFixed(2)} ‚Ç¨</p>
                </div>
                <div class="summary-card savings">
                    <h4>Taux d'√âpargne du Mois</h4>
                    <p class="${savingsRate >= 0 ? 'amount-positive' : 'amount-negative'}">${savingsRate} %</p>
                </div>
            `;
        }

        /**
         * G√©n√®re les onglets pour chaque ann√©e pr√©sente dans `appData.years`
        */
        function renderYearTabs() { 
            const c = document.getElementById('yearTabs'); 
            c.innerHTML = ''; 
            const y = Object.keys(appData.years).sort((a,b)=>parseInt(b)-parseInt(a)); 
            y.forEach(y => { 
                const t = document.createElement('div'); 
                t.className = `year-tab ${y == appData.currentYear ? 'active' : ''}`; 
                t.textContent = y; 
                t.onclick = () => switchYear(y); 
                c.appendChild(t); 
            }); 
        }
        
        function switchYear(y) { 
            appData.currentYear = parseInt(y); 
            resetUiState(); 
            applyRecurrentTransactions(); 
            renderAll(); 
        }

        function addNewYear() { 
            const y = prompt("Entrez l'ann√©e (AAAA) :"); 
            if (y && /^\d{4}$/.test(y)) { 
                const i = parseInt(y); 
                if (!appData.years[i]) { appData.years[i] = createNewYearData(getCurrentStructure()); 
                    appData.currentYear = i; 
                    resetUiState(); 
                    applyRecurrentTransactions(); 
                    renderAll(); 
                } 
            } 
        }

        function deleteCurrentYear() { 
            if (Object.keys(appData.years).length <= 1) { 
                alert("Impossible de supprimer la derni√®re ann√©e restante."); 
                return; 
            } 
            if (confirm(`√ätes-vous s√ªr(e) de vouloir supprimer d√©finitivement l'ann√©e ${appData.currentYear} et toutes ses donn√©es ?`)) { 
                delete appData.years[appData.currentYear]; 
                const remainingYears = Object.keys(appData.years).sort((a,b) => parseInt(b) - parseInt(a)); 
                switchYear(parseInt(remainingYears[0])); alert(`L'ann√©e a √©t√© supprim√©e. Affichage de l'ann√©e ${appData.currentYear}.`); 
                showAutoSaveIndicator(); 
            } 
        }

        function toggleAccountCollapse(accountId) { 
            uiState.collapsed[accountId] = !uiState.collapsed[accountId]; 
            renderTable(); 
        }

        function toggleSectionCollapse(sectionId) { 
            uiState.collapsed[sectionId] = !uiState.collapsed[sectionId]; 
            renderTable(); 
        }

        function collapseAll() { 
            const s=getCurrentStructure(); 
            if(!s) return; 
            s.accounts.forEach(a=>{uiState.collapsed[a.id]=true; 
                a.sections.forEach(c=>uiState.collapsed[c.id]=true);
            }); 
            renderTable(); 
        }

        function expandAll() { 
            resetUiState(); 
            renderTable(); 
        }

        /**
         * Fonction centrale pour afficher la grande table financi√®re
         * Elle parcourt la `structure` de l'ann√©e en cours et affiche chaque compte, section et sous-section
         * G√®re l'√©tat (ouvert/ferm√©) de chaque niveau
        */
        function renderTable() {
            const table = document.getElementById('financialTable'); 
            table.innerHTML = '';
            // Cr√©e l'en-t√™te de la table (Cat√©gorie, Janv, F√©vr, ...)
            const headerRow = document.createElement('tr'); 
            headerRow.innerHTML = '<th>Cat√©gorie</th>' + months.map(m => `<th>${m}</th>`).join('');
            table.appendChild(headerRow);
            const allActions = getActionsForCurrentYear(); 
            const structure = getCurrentStructure(); 
            if (!structure || !structure.accounts) return;
            // Boucle sur chaque compte
            structure.accounts.forEach(account => {
                const isAccountCollapsed = uiState.collapsed[account.id];
                // Affiche la ligne d'en-t√™te pour le compte (cliquable pour ouvrir/fermer)
                const accountRow = document.createElement('tr');
                accountRow.innerHTML = `<th class="account-header" colspan="13" onclick="toggleAccountCollapse('${account.id}')" style="cursor: pointer;">${isAccountCollapsed ? '‚ñ∂' : '‚ñº'} ${account.name}</th>`;
                table.appendChild(accountRow);
                if (!isAccountCollapsed) {
                    // Si le compte est ouvert, on affiche ses sections
                    renderSubsectionRow(table, account.id, "", "", { name: '<em>(Op√©rations sans section)</em>' }, allActions);
                    account.sections.forEach(section => {
                        const isSectionCollapsed = uiState.collapsed[section.id];
                        // Affiche la ligne d'en-t√™te pour la section (cliquable)
                        const sectionRow = document.createElement('tr');
                        sectionRow.innerHTML = `<th class="section-header" colspan="13" onclick="toggleSectionCollapse('${section.id}')" style="cursor: pointer;">${isSectionCollapsed ? '‚ñ∂' : '‚ñº'} ${section.icon || ''} ${section.name}</th>`;
                        table.appendChild(sectionRow);
                        if (!isSectionCollapsed) {
                            // Si la section est ouverte, on affiche ses sous-sections
                            // renderSubsectionRow est appel√©e pour chaque sous-section
                            renderSubsectionRow(table, account.id, section.id, "", { name: '<em>(Op√©rations sans sous-section)</em>' }, allActions);
                            section.subsections.forEach(subsection => renderSubsectionRow(table, account.id, section.id, subsection.id, subsection, allActions));
                            // Affiche la ligne de total pour la section
                            renderSectionTotalRow(table, account.id, section.id, section, allActions);
                        }
                    });
                    // Affiche la ligne de solde pour le compte
                    renderAccountBalanceRow(table, account.id, account, allActions);
                }
            });
            // Affiche la ligne de solde total pour tous les comptes
            renderGrandTotalBalanceRow(table, allActions);
        }

        /**
         * Affiche une seule ligne de sous-section dans la table, avec toutes les op√©rations pour chaque mois
        */
        function renderSubsectionRow(table, accountId, sectionId, subsectionId, subsection, allActions) {
            const relevantActions = allActions.filter(a => a.account === accountId && (a.section || "") === sectionId && (a.subsection || "") === subsectionId);
            if(relevantActions.length === 0 && !subsection.id) return;
            const row = document.createElement('tr'); row.classList.add('subsection-row'); 
            let html = `<td>${subsection.icon || ''} ${subsection.name}</td>`;
            if (!subsection.id) { html = `<td class="category-cell-no-section">${subsection.name}</td>`; }
            for (let i = 0; i < 12; i++) {
                const actionsInMonth = relevantActions.filter(a => a.months[i] !== 0);
                const actionHtml = actionsInMonth.map(a => `<div class="action-item ${a.type === 'projected' ? 'projected' : ''}" onclick="editAction('${a.id}', '${a.type}')"><span>${(a.name)}${a.type==='projected'?' (P)':''}</span><span class="${a.months[i]>=0?'amount-positive':'amount-negative'}">${a.months[i].toFixed(2)}‚Ç¨</span>${a.autoGenerated ? '<span class=recurrent-marker>Auto</span>': ''}</div>`).join('');
                const quickAddBtn = `<button class="quick-add-btn" onclick="showAddActionForm('${accountId}', '${sectionId || ''}', '${subsectionId || ''}', ${i})">+</button>`;
                html += `<td>${actionHtml}${quickAddBtn}</td>`;
            }
            row.innerHTML = html; table.appendChild(row);
        }
        
        /**
         * Affiche la ligne de total pour une section
        */
        function renderSectionTotalRow(table, accountId, sectionId, section, allActions) {
            const row = document.createElement('tr'); row.className = 'section-total-row';
            let html = `<td><strong>Total ${section.icon || ''} ${section.name}</strong></td>`;
            for (let i = 0; i < 12; i++) {
                const total = allActions.filter(a => a.account === accountId && a.section === sectionId).reduce((s, a) => s + a.months[i], 0);
                html += `<td><div class="${total >= 0 ? 'amount-positive' : 'amount-negative'}">${total.toFixed(2)}‚Ç¨</div></td>`;
            }
            row.innerHTML = html; table.appendChild(row);
        }

        /**
         * Affiche la ligne de solde pour un compte
        */
        function renderAccountBalanceRow(table, accountId, account, allActions) {
            const row = document.createElement('tr'); row.className = 'balance-row'; 
            let net = Array(12).fill(0);
            allActions.forEach(a => { if (a.account === accountId) a.months.forEach((amt, i) => { if (amt) net[i] += amt; }); });
            let bal = Array(12).fill(0); bal[0] = getStartingBalance(accountId) + net[0];
            for(let i=1; i<12; i++) bal[i] = bal[i-1] + net[i];
            let html = `<td><strong>Solde ${account.name}</strong></td>`; bal.forEach(b => html += `<td class="${b>=0?'amount-positive':'amount-negative'}">${b.toFixed(2)}‚Ç¨</td>`);
            row.innerHTML = html; table.appendChild(row);
        }

        /**
         * Affiche la ligne de solde total de tous les comptes
        */
        function renderGrandTotalBalanceRow(table, allActions) {
            const row = document.createElement('tr'); row.className = 'grand-total-balance-row'; 
            let totalBal = Array(12).fill(0);
            getCurrentStructure().accounts.forEach(account => {
                let net = Array(12).fill(0); allActions.forEach(a => { if (a.account === account.id) a.months.forEach((amt, i) => net[i] += amt); });
                let accBal = Array(12).fill(0); accBal[0] = getStartingBalance(account.id) + net[0];
                for(let i=1; i<12; i++) accBal[i] = accBal[i-1] + net[i];
                totalBal.forEach((_, i) => totalBal[i] += accBal[i]);
            });
            let html = `<td><strong>Solde Total</strong></td>`; totalBal.forEach(b => html += `<td class="${b>=0?'amount-positive':'amount-negative'}">${b.toFixed(2)}‚Ç¨</td>`);
            row.innerHTML = html; table.appendChild(row);
        }
        
        function renderStartingBalances() {
            const g = document.getElementById('balanceGrid');
            document.getElementById('balanceYear').textContent = appData.currentYear;
            g.innerHTML = '';
            const accounts = getCurrentStructure()?.accounts || [];
            accounts.forEach(a => {
                g.innerHTML += `<div class="balance-item card-style">
                                    <label>${a.name}</label>
                                    <input type="number" value="${getStartingBalance(a.id)}" onchange="updateStartingBalance('${a.id}', this.value)">
                                </div>`;
            });
        }

        function getStartingBalance(id) { 
            return (appData.years[appData.currentYear].startingBalances || {})[id] || 0; 
        }

        function updateStartingBalance(id, value) { 
            if (!appData.years[appData.currentYear].startingBalances) appData.years[appData.currentYear].startingBalances={}; 
            appData.years[appData.currentYear].startingBalances[id] = parseFloat(value) || 0; 
            renderAll(); 
        }


        // --- FORMS & DATA MANIPULATION ---

        /**
         * Affiche la modale pour ajouter ou modifier une op√©ration.
         * @param {string} [accountId] - Pr√©-s√©lectionne le compte si fourni.
         * @param {string} [sectionId] - Pr√©-s√©lectionne la section si fourni.
         * @param {string} [subsectionId] - Pr√©-s√©lectionne la sous-section si fourni.
         * @param {number} [monthIndex] - Pr√©-s√©lectionne le mois si fourni.
        */
        function showAddActionForm(accountId, sectionId, subsectionId, monthIndex) { 
            const modal = document.getElementById('actionModal');
            document.getElementById('formTitle').textContent = 'Ajouter une Op√©ration'; 
            document.getElementById('addOrUpdateButton').textContent = 'Ajouter'; 
            document.getElementById('deleteActionButton').style.display = 'none'; 
            clearActionForm(); 
            populateFormDropdowns();
            if (accountId) document.getElementById('actionAccount').value = accountId;
            populateSections();
            if (sectionId) document.getElementById('actionSection').value = sectionId;
            populateSubsections();
            if (subsectionId) document.getElementById('actionSubsection').value = subsectionId;
            if (monthIndex !== undefined) document.getElementById('actionMonth').value = monthIndex;
            modal.style.display = 'block'; 
            document.getElementById('actionName').focus();
        }

        function hideAddActionForm() { 
            closeModal('actionModal'); 
            appData.editingAction = null; 
            clearActionForm(); 
        }

        function clearActionForm() { 
            ['actionName', 'actionAmount'].forEach(id => document.getElementById(id).value = ''); 
            document.getElementById('actionMonth').value = new Date().getMonth(); 
            document.getElementById('actionType').value = 'actual'; 
            ['actionAccount', 'actionSection', 'actionSubsection'].forEach(id => { 
                const s = document.getElementById(id); 
                if (s && s.options.length > 0) s.selectedIndex = 0; 
            }); 
        }
        
        /**
         * Remplit les menus d√©roulants (comptes, sections, sous-sections) dans les formulaires
         * Cette fonction est appel√©e par beaucoup d'autres pour s'assurer que les listes sont √† jour
        */
        function populateFormDropdowns(accountEl, sectionEl, subsectionEl) {
            const a = document.getElementById(accountEl || 'actionAccount'); 
            if(!a) return;
            const currentVal = a.value; 
            a.innerHTML = '';
            const accounts = getCurrentStructure()?.accounts || [];
            accounts.forEach(acc => { 
                const o = document.createElement('option'); 
                o.value = acc.id; 
                o.textContent = acc.name; 
                a.appendChild(o); 
            });
            if (currentVal) a.value = currentVal;
            populateSections(accountEl, sectionEl, subsectionEl);
        }

        function populateSections(accountEl, sectionEl, subsectionEl) {
            const aIdEl = document.getElementById(accountEl || 'actionAccount'); 
            if (!aIdEl) return;
            const s = document.getElementById(sectionEl || 'actionSection'); 
            if (!s) return;
            const currentVal = s.value; 
            s.innerHTML = '<option value="">Aucune</option>';
            const account = getCurrentStructure()?.accounts.find(acc => acc.id === aIdEl.value);
            if (account) { 
                account.sections.forEach(sec => { 
                    const o = document.createElement('option'); 
                    o.value = sec.id; 
                    o.textContent = `${sec.icon || ''} ${sec.name}`; 
                    s.appendChild(o); 
                }); 
            }
            if (currentVal) s.value = currentVal;
            populateSubsections(accountEl, sectionEl, subsectionEl);
        }

        function populateSubsections(accountEl, sectionEl, subsectionEl) {
            const aIdEl = document.getElementById(accountEl || 'actionAccount');
            const sIdEl = document.getElementById(sectionEl || 'actionSection');
            if (!aIdEl || !sIdEl) return;
            const ss = document.getElementById(subsectionEl || 'actionSubsection'); 
            if (!ss) return;
            const currentVal = ss.value; ss.innerHTML = '<option value="">Aucune</option>';
            if (sIdEl.value) {
                const account = getCurrentStructure()?.accounts.find(acc => acc.id === aIdEl.value);
                if (account) {
                    const section = account.sections.find(sec => sec.id === sIdEl.value);
                    if (section) { 
                        section.subsections.forEach(sub => { 
                            const o = document.createElement('option'); 
                            o.value = sub.id; 
                            o.textContent = `${sub.icon || ''} ${sub.name}`; 
                            ss.appendChild(o); 
                        }); 
                    }
                }
            }
            if (currentVal) ss.value = currentVal;
        }

        function adjustAmountSign(formPrefix = 'action') {
            const accountId = document.getElementById(`${formPrefix}Account`).value;
            const sectionId = document.getElementById(`${formPrefix}Section`).value;
            const subsectionId = document.getElementById(`${formPrefix}Subsection`).value;
            const amountInput = document.getElementById(`${formPrefix}Amount`);
            let amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount === 0) return;
            const structure = getCurrentStructure(); 
            if (!structure) return;
            const account = structure.accounts.find(a => a.id === accountId); 
            if (!account) return;
            let categoryType = null;
            const section = account.sections.find(s => s.id === sectionId);
            if (subsectionId && section) {
                const subsection = section.subsections.find(ss => ss.id === subsectionId);
                if (subsection) categoryType = subsection.categoryType;
            } else if (section) { categoryType = section.categoryType; }
            if (categoryType === 'expense' && amount > 0) { amountInput.value = -amount; }
            else if (categoryType === 'income' && amount < 0) { amountInput.value = Math.abs(amount); }
        }
        
        /**
         * La fonction principale pour ajouter ou mettre √† jour une op√©ration
         * Elle lit les valeurs du formulaire, cr√©e ou modifie un objet dans `appData.years[...].actual` ou `projected`, puis appelle `renderAll()` pour rafra√Æchir l'affichage
        */
        function addAction() {
            const n = document.getElementById('actionName').value;
            const a = document.getElementById('actionAccount').value;
            const s = document.getElementById('actionSection').value;
            const ss = document.getElementById('actionSubsection').value;
            const m = parseInt(document.getElementById('actionMonth').value);
            const amt = parseFloat(document.getElementById('actionAmount').value);
            const t = document.getElementById('actionType').value;
            if (!a || isNaN(amt)) return alert('Veuillez remplir les champs obligatoires : Compte et Montant.'); 
            if (appData.editingAction) {
                const originalAction = appData.years[appData.currentYear][appData.editingAction.type][appData.editingAction.id];
                if (originalAction && originalAction.autoGenerated && t === 'actual') {
                    const newId = 'action_' + Date.now();
                    appData.years[appData.currentYear]['actual'][newId] = { 
                        id: newId, 
                        name: n, 
                        account: a, 
                        section: s, 
                        subsection: ss, 
                        months: Array(12).fill(0), 
                        autoGenerated: false, 
                        recurrentSourceId: originalAction.recurrentSourceId 
                    };
                    appData.years[appData.currentYear]['actual'][newId].months[m] = amt;
                    delete appData.years[appData.currentYear][originalAction.type][originalAction.id];
                    renderAll(); 
                    hideAddActionForm(); 
                    return;
                }
                const { type: originalType, id: originalId } = appData.editingAction;
                const transaction = appData.years[appData.currentYear][originalType][originalId];
                if (!transaction) { 
                    hideAddActionForm(); 
                    return; 
                }
                transaction.name = n; 
                transaction.account = a; 
                transaction.section = s; 
                transaction.subsection = ss; 
                transaction.months.fill(0); 
                transaction.months[m] = amt;
                if (t !== originalType) {
                    if (!appData.years[appData.currentYear][t]) { appData.years[appData.currentYear][t] = {}; }
                    appData.years[appData.currentYear][t][originalId] = transaction;
                    delete appData.years[appData.currentYear][originalType][originalId];
                }
            } else { 
                if (!appData.years[appData.currentYear][t]) { appData.years[appData.currentYear][t] = {}; }
                const id = 'action_' + Date.now(); 
                appData.years[appData.currentYear][t][id] = { 
                    id, 
                    name: n, 
                    account: a, 
                    section: s, 
                    subsection: ss, 
                    months: Array(12).fill(0) 
                }; 
                appData.years[appData.currentYear][t][id].months[m] = amt; 
            }
            renderAll(); 
            hideAddActionForm();
        }

        /**
         * Pr√©pare le formulaire pour modifier une op√©ration existante
         * @param {string} id - L'ID de l'action √† modifier
         * @param {string} type - 'actual' ou 'projected'
        */
        function editAction(id, type) { 
            const a = appData.years[appData.currentYear][type][id]; 
            if (!a) return; 
            if (a.isTransfer) { return editTransfer(id); }
            showAddActionForm();
            document.getElementById('formTitle').textContent="Modifier l'Op√©ration"; 
            document.getElementById('addOrUpdateButton').textContent='Mettre √† Jour'; 
            document.getElementById('deleteActionButton').style.display = a.autoGenerated ? 'none' : 'inline-block';
            let m = a.months.findIndex(v => v !== 0); 
            if (m === -1) m = 0; 
            document.getElementById('actionName').value = a.name; 
            document.getElementById('actionAccount').value = a.account; 
            populateSections(); 
            document.getElementById('actionSection').value = a.section || "";
            populateSubsections(); 
            document.getElementById('actionSubsection').value = a.subsection || "";
            document.getElementById('actionMonth').value=m; 
            document.getElementById('actionAmount').value=a.months[m]||0; 
            document.getElementById('actionType').value = a.autoGenerated ? 'actual' : type; 
            document.getElementById('actionType').querySelector('option[value="projected"]').disabled = !!a.autoGenerated;
            appData.editingAction = {id, type};
        }

        /**
         * Supprime une op√©ration
         */
        function deleteAction() {
            if (!appData.editingAction) return;
            const { id, type } = appData.editingAction;
            const a = appData.years[appData.currentYear][type][id];
            if (a.isTransfer || a.autoGenerated) { 
                alert("Cette op√©ration ne peut √™tre supprim√©e ici."); 
                return; 
            }
            if (confirm('√ätes-vous s√ªr(e) ?')) { 
                delete appData.years[appData.currentYear][type][id]; 
                renderAll(); 
                hideAddActionForm(); 
            }
        }
        
        function showTransferModal() {
            appData.editingTransferId = null;
            const modal = document.getElementById('transferModal');
            document.getElementById('transferModalTitle').textContent = 'Effectuer un Virement Inter-compte';
            document.getElementById('addOrUpdateTransferButton').textContent = 'Effectuer le Virement';
            document.getElementById('deleteTransferButton').style.display = 'none';
            document.getElementById('transferName').value = ''; 
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferMonth').value = new Date().getMonth(); 
            populateTransferFormDropdowns(); 
            modal.style.display = 'block';
        }

        function populateTransferFormDropdowns() {
            const sourceSelect = document.getElementById('transferSourceAccount');
            const destSelect = document.getElementById('transferDestAccount');
            sourceSelect.innerHTML = ''; 
            destSelect.innerHTML = '';
            const accounts = getCurrentStructure()?.accounts || [];
            accounts.forEach(acc => {
                const o1 = document.createElement('option'); 
                o1.value = acc.id; 
                o1.textContent = acc.name; 
                sourceSelect.appendChild(o1);
                const o2 = document.createElement('option'); 
                o2.value = acc.id; 
                o2.textContent = acc.name; 
                destSelect.appendChild(o2);
            });
        }
        
        function addTransfer() {
            const n = document.getElementById('transferName').value;
            const src = document.getElementById('transferSourceAccount').value;
            const dest = document.getElementById('transferDestAccount').value;
            const m = parseInt(document.getElementById('transferMonth').value);
            const amt = parseFloat(document.getElementById('transferAmount').value);
            if (src === dest) return alert("Les comptes doivent √™tre diff√©rents.");
            if (isNaN(amt) || amt <= 0) return alert("Veuillez entrer un montant valide.");
            if (appData.editingTransferId) {
                delete appData.years[appData.currentYear].actual[`${appData.editingTransferId}_debit`];
                delete appData.years[appData.currentYear].actual[`${appData.editingTransferId}_credit`];
            }
            ensureTransferSectionExists(src);
            ensureTransferSectionExists(dest);
            const baseId = appData.editingTransferId || `transfer_${Date.now()}`;
            const debit = { id: `${baseId}_debit`, name: n || `Virement vers ${document.getElementById('transferDestAccount').options[document.getElementById('transferDestAccount').selectedIndex].text}`, account: src, section: VIREMENT_SECTION_ID, subsection: '', months: Array(12).fill(0), isTransfer: true };
            debit.months[m] = -amt;
            const credit = { id: `${baseId}_credit`, name: n || `Virement depuis ${document.getElementById('transferSourceAccount').options[document.getElementById('transferSourceAccount').selectedIndex].text}`, account: dest, section: VIREMENT_SECTION_ID, subsection: '', months: Array(12).fill(0), isTransfer: true };
            credit.months[m] = amt;
            if (!appData.years[appData.currentYear]['actual']) appData.years[appData.currentYear]['actual'] = {};
            appData.years[appData.currentYear]['actual'][debit.id] = debit;
            appData.years[appData.currentYear]['actual'][credit.id] = credit;
            renderAll();
            closeModal('transferModal');
            alert(appData.editingTransferId ? 'Virement mis √† jour !' : 'Virement effectu√© !');
        }

        function ensureTransferSectionExists(accountId) { 
            const acc=getCurrentStructure().accounts.find(a=>a.id===accountId); 
            if(acc&&!acc.sections.find(s=>s.id===VIREMENT_SECTION_ID))acc.sections.push({id:VIREMENT_SECTION_ID,name:VIREMENT_SECTION_NAME,subsections:[], categoryType: 'expense'}); 
        }

        function editTransfer(actionId) {
            const baseId = actionId.split('_').slice(0, 2).join('_');
            const debitAction = appData.years[appData.currentYear].actual[`${baseId}_debit`];
            if (!debitAction) return alert("Erreur: Virement introuvable.");
            appData.editingTransferId = baseId;
            const modal = document.getElementById('transferModal');
            document.getElementById('transferModalTitle').textContent = 'Modifier le Virement';
            document.getElementById('addOrUpdateTransferButton').textContent = 'Mettre √† jour';
            document.getElementById('deleteTransferButton').style.display = 'inline-block';
            populateTransferFormDropdowns();
            const amount = Math.abs(debitAction.months.find(m => m !== 0) || 0);
            const monthIndex = debitAction.months.findIndex(m => m !== 0);
            const creditAction = appData.years[appData.currentYear].actual[`${baseId}_credit`];
            document.getElementById('transferName').value = debitAction.name.startsWith('Virement vers') ? '' : debitAction.name;
            document.getElementById('transferSourceAccount').value = debitAction.account;
            document.getElementById('transferDestAccount').value = creditAction.account;
            document.getElementById('transferMonth').value = monthIndex;
            document.getElementById('transferAmount').value = amount;
            modal.style.display = 'block';
        }

        function deleteTransfer() {
            if (!appData.editingTransferId) return;
            if (confirm("√ätes-vous s√ªr(e) de vouloir supprimer ce virement ?")) {
                delete appData.years[appData.currentYear].actual[`${appData.editingTransferId}_debit`];
                delete appData.years[appData.currentYear].actual[`${appData.editingTransferId}_credit`];
                renderAll();
                closeModal('transferModal');
                alert("Virement supprim√©.");
            }
        }


        // --- STATS, STRUCTURE, BUDGET, RECURRENT ---
        
        function getCssVariable(variable) {
            return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
        }


        // --- STATS MODALE ---

        function showStats() { 
            const m=document.getElementById('statsModal'); 
            m.querySelector('#stats-modal-title').textContent=`Statistiques pour ${appData.currentYear}`; 
            m.querySelector('#statsContent').innerHTML=generateStatsContent(); 
            m.style.display='block'; 
            setTimeout(createCharts, 150); 
        }

        function generateStatsContent() {
            const allActions = getActualActionsForCurrentYear();
            const structure = getCurrentStructure();
            const monthlyIncome = Array(12).fill(0);
            const monthlyExpenses = Array(12).fill(0);
            const monthlyTotalBudget = Array(12).fill(0);
            const monthlyBiggestExpenseCategory = Array(12).fill('‚Äî');
            structure.accounts.forEach(account => {
                account.sections.forEach(section => {
                    for(let i=0; i<12; i++) {
                        monthlyTotalBudget[i] += getSectionBudgetForMonth(section, i);
                    }
                });
            });
            for (let i = 0; i < 12; i++) {
                const expensesInMonthByCategory = {};
                allActions.forEach(action => {
                    if (action.isTransfer) return;
                    const amount = action.months[i] || 0;
                    if (amount > 0) {
                        monthlyIncome[i] += amount;
                    } else if (amount < 0) {
                        const expenseAmount = Math.abs(amount);
                        monthlyExpenses[i] += expenseAmount;
                        const account = structure.accounts.find(acc => acc.id === action.account);
                        const section = account ? account.sections.find(sec => sec.id === action.section) : null;
                        const subsection = section ? section.subsections.find(sub => sub.id === action.subsection) : null;
                        let categoryName = subsection ? `${subsection.icon || ''} ${subsection.name}` : (section ? `${section.icon || ''} ${section.name}` : 'Non Cat√©goris√©');
                        expensesInMonthByCategory[categoryName] = (expensesInMonthByCategory[categoryName] || 0) + expenseAmount;
                    }
                });
                if (Object.keys(expensesInMonthByCategory).length > 0) {
                    monthlyBiggestExpenseCategory[i] = Object.entries(expensesInMonthByCategory).reduce((a, b) => a[1] > b[1] ? a : b)[0];
                }
            }
            let summaryTableHtml = `<div class="table-container" style="margin-bottom: 20px;"><table class="financial-table"><thead><tr><th>Mois</th><th>Revenus</th><th>D√©penses</th><th>Solde Mensuel</th><th>Budget</th><th>Diff. Budget</th><th>Plus Grosse D√©pense</th></tr></thead><tbody>`;
            for (let i = 0; i < 12; i++) {
                const monthlyBalance = monthlyIncome[i] - monthlyExpenses[i];
                const budgetDiff = monthlyTotalBudget[i] - monthlyExpenses[i];
                summaryTableHtml += `<tr><td><strong>${months[i]}</strong></td><td class="amount-positive">${monthlyIncome[i].toFixed(2)}‚Ç¨</td><td class="amount-negative">${monthlyExpenses[i].toFixed(2)}‚Ç¨</td><td class="${monthlyBalance >= 0 ? 'amount-positive' : 'amount-negative'}">${monthlyBalance.toFixed(2)}‚Ç¨</td><td>${monthlyTotalBudget[i] > 0 ? monthlyTotalBudget[i].toFixed(2)+'‚Ç¨' : '‚Äî'}</td><td class="${budgetDiff >= 0 ? 'amount-positive' : 'amount-negative'}">${monthlyTotalBudget[i] > 0 ? budgetDiff.toFixed(2)+'‚Ç¨' : '‚Äî'}</td><td>${monthlyBiggestExpenseCategory[i]}</td></tr>`;
            }
            summaryTableHtml += '</tbody></table></div>';
            let detailTableHtml = `<h3 style="margin-top: 30px;">D√©tail D√©penses vs. Budget par Mois</h3><div class="table-container"><table class="financial-table"><thead><tr><th>Mois</th><th>Section</th><th>Sous-section</th><th>D√©penses</th><th>Budget</th><th>Diff√©rence</th></tr></thead><tbody>`;
            for (let i = 0; i < 12; i++) {
                const monthRows = [];
                structure.accounts.forEach(account => {
                    account.sections.forEach(section => {
                        section.subsections.forEach(subsection => {
                            if (subsection.categoryType === 'expense') {
                                const spent = Math.abs(allActions.filter(a => a.account === account.id && a.section === section.id && a.subsection === subsection.id).reduce((sum, a) => sum + (a.months[i] || 0), 0));
                                const budget = getActiveBudgetForMonth(subsection, i);
                                if (spent > 0 || budget > 0) {
                                    const diff = budget - spent;
                                    monthRows.push({ sectionName: `${section.icon || ''} ${section.name}`, subsectionName: `${subsection.icon || ''} ${subsection.name}`, spent: spent.toFixed(2) + '‚Ç¨', budget: budget > 0 ? budget.toFixed(2) + '‚Ç¨' : '‚Äî', diff: budget > 0 ? `<span class="${diff >= 0 ? 'amount-positive' : 'amount-negative'}">${diff.toFixed(2)}‚Ç¨</span>` : '‚Äî' });
                                }
                            }
                        });
                    });
                });
                if (monthRows.length > 0) {
                    monthRows.forEach((row, rowIndex) => {
                        detailTableHtml += `<tr>${rowIndex === 0 ? `<td rowspan="${monthRows.length}"><strong>${fullMonths[i]}</strong></td>` : ''}<td>${row.sectionName}</td><td>${row.subsectionName}</td><td>${row.spent}</td><td>${row.budget}</td><td>${row.diff}</td></tr>`;
                    });
                }
            }
            detailTableHtml += '</tbody></table></div>';
            return `<div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="downloadStatsPNG()">‚¨áÔ∏è T√©l√©charger les statistiques</button></div><div id="statsExportArea"><h3>R√©sum√© Annuel</h3>${summaryTableHtml}<div class="chart-container"><h3>Aper√ßu du Solde Total</h3><canvas id="balanceOverviewChart"></canvas></div><div class="chart-container"><h3>Revenus vs D√©penses par Mois</h3><canvas id="incomeExpensesChart"></canvas></div>${detailTableHtml}</div>`;
        }

        function createCharts() {
            const allActions = getActualActionsForCurrentYear();
            let totalBalanceData = Array(12).fill(0);
            (getCurrentStructure()?.accounts || []).forEach(account => {
                let monthlyNet = Array(12).fill(0); 
                allActions.forEach(a => { if (a.account === account.id) a.months.forEach((amt, i) => monthlyNet[i] += amt); });
                let cumulative = Array(12).fill(0); 
                cumulative[0] = getStartingBalance(account.id) + monthlyNet[0];
                for (let i = 1; i < 12; i++) { cumulative[i] = cumulative[i - 1] + monthlyNet[i]; }
                totalBalanceData.forEach((_, i) => totalBalanceData[i] += cumulative[i]);
            });
            const balCtx = document.getElementById('balanceOverviewChart'); 
            if (balCtx) { 
                if (Chart.getChart(balCtx)) Chart.getChart(balCtx).destroy();
                new Chart(balCtx, { type: 'line', data: { labels: months, datasets: [{ label: 'Solde Total', data: totalBalanceData, borderColor: getCssVariable('--primary-color'), backgroundColor: 'rgba(13, 71, 161, 0.2)', tension: 0.4, fill: true }] }, options: { responsive: true, animation: false, scales: { y: { ticks: { callback: v => v.toFixed(0) + '‚Ç¨' } } } } }); 
            }
            const monthlyIncome = Array(12).fill(0);
            const monthlyExpensesBySection = {};
            const expenseSections = [];
            const structure = getCurrentStructure();
            if (structure) { 
                structure.accounts.forEach(acc => acc.sections.forEach(sec => { 
                    if (!expenseSections.find(s => s.id === sec.id)) expenseSections.push({ id: sec.id, name: `${sec.icon || ''} ${sec.name}`}); 
                })); 
            }
            expenseSections.push({ id: 'uncategorized', name: 'Non Cat√©goris√©' });
            expenseSections.forEach(sec => { monthlyExpensesBySection[sec.id] = Array(12).fill(0); });
            allActions.forEach(a => { 
                if (a.isTransfer) return; 
                a.months.forEach((amt, i) => { 
                    if (amt > 0) { monthlyIncome[i] += amt; } 
                    else if (amt < 0) { 
                        const sectionId = a.section || 'uncategorized'; 
                        if (monthlyExpensesBySection[sectionId]) { monthlyExpensesBySection[sectionId][i] += Math.abs(amt); } 
                    } 
                }); 
            });
            const colorPalette = ['#EF5350', '#FFA726', '#5C6BC0', '#FF7043', '#8D6E63', '#EC407A', '#78909C', '#AB47BC'];
            const datasets = [{ label: 'Revenus', data: monthlyIncome, backgroundColor: getCssVariable('--success-color'), stack: 'incomeStack' }];
            let colorIndex = 0;
            expenseSections.forEach(sec => { 
                if (monthlyExpensesBySection[sec.id].reduce((s, v) => s + v, 0) > 0) { 
                    datasets.push({ label: sec.name, data: monthlyExpensesBySection[sec.id], backgroundColor: colorPalette[colorIndex++ % colorPalette.length], stack: 'expenseStack' }); 
                } 
            });
            const incExpCtx = document.getElementById('incomeExpensesChart');
            if (incExpCtx) { 
                if (Chart.getChart(incExpCtx)) Chart.getChart(incExpCtx).destroy();
                new Chart(incExpCtx, { 
                    type: 'bar', 
                    data: { labels: months, datasets: datasets }, 
                    options: { responsive: true, animation: false, plugins: { tooltip: { callbacks: { footer: function(items) { if (items[0].dataset.stack === 'expenseStack') { let total = items.reduce((a, b) => a + b.parsed.y, 0); return 'Total D√©penses: ' + total.toFixed(2) + '‚Ç¨'; } return ''; } } } }, 
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { callback: v => v.toFixed(0) + '‚Ç¨' } } } } 
                }); 
            }
        }

        function downloadStatsPNG() { 
            const a=document.getElementById('statsExportArea');
            html2canvas(a,{backgroundColor:'#ffffff',scale:2}).then(c=>{
                const d=c.toDataURL('image/png');
                const e=document.createElement('a');
                e.href=d;
                e.download=`statistiques-${appData.currentYear}.png`;
                e.click();
            }); 
        }
        

        // --- STRUCTURE MANAGEMENT ---

        function showStructureManager() { 
            structureUiState.collapsed = {}; 
            const m = document.getElementById('structureModal'); 
            m.querySelector('#structureContent').innerHTML = generateStructureContent(); 
            m.style.display = 'block'; 
        }

        function toggleStructureAccountCollapse(accountId) { 
            structureUiState.collapsed[accountId] = !structureUiState.collapsed[accountId]; 
            document.getElementById('structureContent').innerHTML = generateStructureContent(); 
        }

        function toggleStructureSectionCollapse(sectionId) { 
            structureUiState.collapsed[sectionId] = !structureUiState.collapsed[sectionId]; 
            document.getElementById('structureContent').innerHTML = generateStructureContent(); 
        }

        function generateStructureContent() {
            let h = '<div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="addNewAccount()">+ Ajouter Compte</button></div>';
            const accounts = getCurrentStructure().accounts;
            accounts.forEach((account) => {
                h += `<div class="structure-item card-style account">
                        <div class="structure-item-name"><span style="cursor: pointer;" onclick="toggleStructureAccountCollapse('${account.id}')"><strong>${structureUiState.collapsed[account.id] ? '‚ñ∂' : '‚ñº'} ${account.name}</strong></span></div>
                        <div class="structure-actions"><button class="btn btn-primary" onclick="addNewSection('${account.id}')">+ Section</button><button class="btn btn-warning" onclick="editAccount('${account.id}')">Modifier</button><button class="btn btn-danger" onclick="deleteAccount('${account.id}')">Supprimer</button></div>
                      </div>`;
                if (!structureUiState.collapsed[account.id]) {
                    account.sections.forEach((section) => {
                        const typeDropdown = `<select onchange="updateCategoryType('section', {accountId: '${account.id}', sectionId: '${section.id}'}, this.value)"><option value="expense" ${section.categoryType === 'expense' ? 'selected' : ''}>D√©pense</option><option value="income" ${section.categoryType === 'income' ? 'selected' : ''}>Revenu</option></select>`;
                        h += `<div class="structure-item card-style section">
                                <div class="structure-item-name">
                                    <input type="text" class="icon-input" value="${section.icon || ''}" placeholder="ico" onchange="updateStructureIcon('section', {accountId: '${account.id}', sectionId: '${section.id}'}, this.value)">
                                    <span style="cursor: pointer;" onclick="toggleStructureSectionCollapse('${section.id}')">${structureUiState.collapsed[section.id] ? '‚ñ∂' : '‚ñº'} ${section.name}</span> ${typeDropdown}
                                </div>
                                <div class="structure-actions"><button class="btn btn-primary" onclick="addNewSubsection('${account.id}', '${section.id}')">+ Sous-section</button><button class="btn btn-warning" onclick="editSection('${account.id}', '${section.id}')">Modifier</button><button class="btn btn-danger" onclick="deleteSection('${account.id}', '${section.id}')">Supprimer</button></div>
                              </div>`;
                        if (!structureUiState.collapsed[section.id]) {
                            section.subsections.forEach((subsection) => {
                                const subTypeDropdown = `<select onchange="updateCategoryType('subsection', {accountId: '${account.id}', sectionId: '${section.id}', subsectionId: '${subsection.id}'}, this.value)"><option value="expense" ${subsection.categoryType === 'expense' ? 'selected' : ''}>D√©pense</option><option value="income" ${subsection.categoryType === 'income' ? 'selected' : ''}>Revenu</option></select>`;
                                h += `<div class="structure-item card-style subsection">
                                        <div class="structure-item-name">
                                            <input type="text" class="icon-input" value="${subsection.icon || ''}" placeholder="ico" onchange="updateStructureIcon('subsection', {accountId: '${account.id}', sectionId: '${section.id}', subsectionId: '${subsection.id}'}, this.value)">
                                            <span>${subsection.name}</span> ${subTypeDropdown}
                                        </div>
                                        <div class="structure-actions"><button class="btn btn-warning" onclick="editSubsection('${account.id}', '${section.id}', '${subsection.id}')">Modifier</button><button class="btn btn-danger" onclick="deleteSubsection('${account.id}', '${section.id}', '${subsection.id}')">Supprimer</button></div>
                                      </div>`;
                            });
                        }
                    });
                }
            });
            return h;
        }

        function updateStructureIcon(level, ids, icon) {
            const account = getCurrentStructure().accounts.find(a => a.id === ids.accountId); 
            if (!account) return;
            let category;
            if (level === 'section') {
                category = account.sections.find(s => s.id === ids.sectionId);
            } else {
                const section = account.sections.find(s => s.id === ids.sectionId);
                if (section) category = section.subsections.find(ss => ss.id === ids.subsectionId);
            }
            if (category) {
                category.icon = icon;
                renderStructureAndAll();
            }
        }

        function updateCategoryType(level, ids, newType) {
            let category; const account = getCurrentStructure().accounts.find(a => a.id === ids.accountId); 
            if (!account) return;
            const section = account.sections.find(s => s.id === ids.sectionId); 
            if (!section) return;
            if (level === 'section') category = section;
            else if (level === 'subsection') category = section.subsections.find(ss => ss.id === ids.subsectionId);
            if (category) {
                category.categoryType = newType;
                if (level === 'section') { category.subsections.forEach(sub => sub.categoryType = newType); }
                if (newType === 'income' && category.budgets) { category.budgets = []; }
                renderStructureAndAll();
            }
        }

        function addNewAccount(){
            const n=prompt("Nom du nouveau compte:");
            if(n){
                const i='account_'+Date.now();
                getCurrentStructure().accounts.push({id:i,name:n,sections:[]});
                renderStructureAndAll();
            }
        }

        function addNewSection(aId){
            const n=prompt("Nom de la nouvelle section:");
            if(n){
                const a=getCurrentStructure().accounts.find(x=>x.id===aId);
                if(a){
                    const i='section_'+Date.now(); 
                    a.sections.push({id:i,name:n,icon:'',subsections:[],categoryType:'expense'});
                    renderStructureAndAll();
                }
            }
        }

        function addNewSubsection(aId,sId){
            const e=prompt("Nom de la nouvelle sous-section:");
            if(e){
                const a=getCurrentStructure().accounts.find(x=>x.id===aId);
                if(a){
                    const s=a.sections.find(x=>x.id===sId);
                    if(s){
                        const i='subsection_'+Date.now(); 
                        s.subsections.push({id:i,name:e,icon:'',budgets:[],categoryType:s.categoryType});
                        renderStructureAndAll();
                    }
                }
            }
        }

        function editAccount(aId){
            const a=getCurrentStructure().accounts.find(x=>x.id===aId);
            if(!a)return;
            const e=prompt("Modifier le nom:",a.name);
            if(e&&e!==a.name){
                a.name=e;
                renderStructureAndAll();
            }
        }

        function editSection(aId,sId){
            const a=getCurrentStructure().accounts.find(x=>x.id===aId);
            if(!a)return;
            const s=a.sections.find(x=>x.id===sId);
            if(!s)return;
            const o=prompt("Modifier le nom:",s.name);
            if(o&&o!==s.name){
                s.name=o;
                renderStructureAndAll();
            }
        }

        function editSubsection(aId,sId,ssId){
            const a=getCurrentStructure().accounts.find(x=>x.id===aId);
            if(!a)return;
            const s=a.sections.find(x=>x.id===sId);
            if(!s)return;
            const ss=s.subsections.find(x=>x.id===ssId);
            if(!ss)return;
            const n=prompt("Modifier le nom:",ss.name);
            if(n&&n!==ss.name){
                ss.name=n;
                renderStructureAndAll();
            }
        }

        function deleteAccount(aId){
            if(confirm("S√ªr? Ceci supprimera le compte et toutes ses donn√©es.")){
                const a=getCurrentStructure().accounts;
                const i=a.findIndex(x=>x.id===aId);
                if(i>-1){a.splice(i,1);
                    renderStructureAndAll();
                }
            }
        }

        function deleteSection(aId,sId){
            if(confirm("S√ªr? Ceci supprimera la section et ses donn√©es.")){
                const a=getCurrentStructure().accounts.find(x=>x.id===aId);
                if(a){
                    const i=a.sections.findIndex(x=>x.id===sId);
                    if(i>-1){
                        a.sections.splice(i,1);
                        renderStructureAndAll();
                    }
                }
            }
        }

        function deleteSubsection(aId,sId,ssId){
            if(confirm("S√ªr? Ceci supprimera la sous-section et ses donn√©es.")){
                const a=getCurrentStructure().accounts.find(x=>x.id===aId);
                if(a){
                    const s=a.sections.find(x=>x.id===sId);
                    if(s){
                        const i=s.subsections.findIndex(x=>x.id===ssId);
                        if(i>-1){
                            s.subsections.splice(i,1);
                            renderStructureAndAll();
                        }
                    }
                }
            }
        }

        function renderStructureAndAll() { 
            document.getElementById('structureContent').innerHTML = generateStructureContent(); 
            populateFormDropdowns(); 
            renderTable(); 
            renderStartingBalances(); 
        }


        // --- BUDGET MANAGEMENT ---

        function getActiveBudgetForMonth(subsection, monthIndex) { 
            if (!subsection.budgets || subsection.categoryType !== 'expense') return 0; 
            const b = subsection.budgets.find(b => monthIndex >= b.startMonth && monthIndex <= b.endMonth); 
            return b ? b.amount : 0; 
        }

        function getSectionBudgetForMonth(section, monthIndex) { 
            if (section.categoryType !== 'expense') return 0; 
            return section.subsections.reduce((t, s) => t + getActiveBudgetForMonth(s, monthIndex), 0); 
        }

        function showBudgetManager() { 
            const m = document.getElementById('budgetModal'); 
            m.querySelector('#budgetManagerContent').innerHTML = generateBudgetManagerContent(); 
            m.style.display = 'block'; 
        }

        function generateBudgetManagerContent() {
            let html = '';
            const structure = getCurrentStructure(); 
            const monthOptions = fullMonths.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            structure.accounts.forEach(account => {
                const hasExpenseSubsections = account.sections.some(s => s.subsections.some(ss => ss.categoryType === 'expense'));
                if (!hasExpenseSubsections) return;
                html += `<h2 class="budget-account-title">${account.name}</h2>`;
                account.sections.forEach(section => {
                    const expenseSubsections = section.subsections.filter(ss => ss.categoryType === 'expense');
                    if (expenseSubsections.length > 0) {
                        html += `<h3 class="budget-section-title">${section.icon || ''} ${section.name}</h3>`;
                        expenseSubsections.forEach(subsection => {
                            html += `<div class="budget-card card-style">
                                        <h4>${subsection.icon || ''} ${subsection.name}</h4>
                                        ${generateBudgetPeriodsList({accountId: account.id, sectionId: section.id, subsectionId: subsection.id}, subsection.budgets)}
                                        ${generateBudgetForm({accountId: account.id, sectionId: section.id, subsectionId: subsection.id}, monthOptions)}
                                    </div>`;
                        });
                    }
                });
            });
            return html || "<p>Aucune sous-cat√©gorie de d√©pense n'a √©t√© d√©finie pour cr√©er des budgets.</p>";
        }

        function generateBudgetPeriodsList(ids, budgets) { 
            if (!budgets || budgets.length === 0) return '<p style="font-size: 13px; color: var(--text-color-light); margin-bottom: 15px;">Aucun budget d√©fini.</p>'; 
            return budgets.map((b, index) => `<div class="budget-period"><span><strong>${b.amount.toFixed(2)}‚Ç¨</strong> de ${fullMonths[b.startMonth]} √† ${fullMonths[b.endMonth]}</span><button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteBudgetPeriod(JSON.parse(atob('${btoa(JSON.stringify(ids))}')), ${index})">X</button></div>`).join(''); 
        }

        function generateBudgetForm(ids, monthOptions) { 
            const uid = `${ids.accountId}-${ids.sectionId}-${ids.subsectionId}`; 
            return `<div class="budget-form"><input type="number" placeholder="Montant" id="budget-amount-${uid}" step="0.01"><select id="budget-start-${uid}">${monthOptions}</select><select id="budget-end-${uid}">${monthOptions}</select><button class="btn btn-success" onclick="addBudgetPeriod(JSON.parse(atob('${btoa(JSON.stringify(ids))}')))">Ajouter</button></div>`; 
        }

        function addBudgetPeriod(ids) {
            const uid = `${ids.accountId}-${ids.sectionId}-${ids.subsectionId}`;
            const amount = parseFloat(document.getElementById(`budget-amount-${uid}`).value);
            const startMonth = parseInt(document.getElementById(`budget-start-${uid}`).value);
            const endMonth = parseInt(document.getElementById(`budget-end-${uid}`).value);
            if (isNaN(amount) || amount <= 0) return alert('Veuillez entrer un montant valide.');
            if (startMonth > endMonth) return alert('Le mois de d√©but ne peut pas √™tre apr√®s le mois de fin.');
            const subsection = getCurrentStructure().accounts.find(a => a.id === ids.accountId)?.sections.find(s => s.id === ids.sectionId)?.subsections.find(ss => ss.id === ids.subsectionId);
            if (!subsection) return;
            const isOverlapping = subsection.budgets.some(p => Math.max(p.startMonth, startMonth) <= Math.min(p.endMonth, endMonth));
            if (isOverlapping) return alert("Cette p√©riode de budget chevauche une p√©riode existante.");
            subsection.budgets.push({ amount, startMonth, endMonth });
            subsection.budgets.sort((a,b) => a.startMonth - b.startMonth);
            showBudgetManager(); 
            renderTable();
        }

        function deleteBudgetPeriod(ids, index) {
            const subsection = getCurrentStructure().accounts.find(a => a.id === ids.accountId)?.sections.find(s => s.id === ids.sectionId)?.subsections.find(ss => ss.id === ids.subsectionId);
            if (subsection && subsection.budgets[index] !== undefined) { 
                subsection.budgets.splice(index, 1); 
                showBudgetManager(); 
                renderTable(); 
            }
        }


        // --- RECURRENT TRANSACTIONS ---

        /**
         * Affiche la modale pour g√©rer les op√©rations r√©currentes
        */
        function showRecurrentModal() { 
            const m = document.getElementById('recurrentModal'); 
            populateFormDropdowns('recurrentAccount', 'recurrentSection', 'recurrentSubsection'); 
            renderRecurrentList(); 
            clearRecurrentForm(); m.style.display = 'block'; 
        }

        function renderRecurrentList() {
            const listDiv = document.getElementById('recurrentList');
            const transactions = appData.years[appData.currentYear]?.recurrentTransactions || [];
            if (transactions.length === 0) { 
                listDiv.innerHTML = '<p>Aucune op√©ration r√©currente d√©finie pour cette ann√©e.</p>'; 
                return; 
            }
            let html = '<h3>Op√©rations R√©currentes Actives</h3>';
            transactions.forEach(t => { html += `<div class="structure-item card-style"><span><strong>${t.name}</strong> (${t.amount.toFixed(2)}‚Ç¨/mois) - <em>Type: ${t.type === 'actual' ? 'R√©el' : 'Projet√©'}</em></span><div class="structure-actions"><button class="btn btn-warning" onclick="editRecurrentTransaction('${t.id}')">Modifier</button><button class="btn btn-danger" onclick="deleteRecurrentTransaction('${t.id}')">Supprimer</button></div></div>`; });
            listDiv.innerHTML = html;
        }

        /**
         * Sauvegarde une nouvelle r√®gle de r√©currence ou met √† jour une r√®gle existante
        */
        function saveRecurrentTransaction() {
            const name = document.getElementById('recurrentName').value; 
            let amount = parseFloat(document.getElementById('recurrentAmount').value);
            if (isNaN(amount)) return alert("Veuillez renseigner un montant valide.");
            adjustAmountSign('recurrent'); 
            amount = parseFloat(document.getElementById('recurrentAmount').value); 
            const data = { 
                name, 
                amount, 
                account: document.getElementById('recurrentAccount').value, 
                section: document.getElementById('recurrentSection').value, 
                subsection: document.getElementById('recurrentSubsection').value, 
                startDate: document.getElementById('recurrentStartDate').value, 
                endDate: document.getElementById('recurrentEndDate').value, 
                type: document.getElementById('recurrentType').value 
            };
            const list = appData.years[appData.currentYear].recurrentTransactions;
            if (appData.editingRecurrent) { const i = list.findIndex(t => t.id === appData.editingRecurrent); if (i > -1) list[i] = { ...list[i], ...data }; }
            else { data.id = 'recurrent_' + Date.now(); list.push(data); }
            clearRecurrentForm(); 
            renderRecurrentList(); 
            applyRecurrentTransactions(); 
            renderAll();
        }

        function editRecurrentTransaction(id) {
            const t = appData.years[appData.currentYear].recurrentTransactions.find(trans => trans.id === id); if (!t) return;
            appData.editingRecurrent = id;
            document.getElementById('recurrentFormTitle').textContent = "Modifier l'Op√©ration R√©currente"; 
            document.getElementById('addOrUpdateRecurrentButton').textContent = 'Mettre √† Jour';
            document.getElementById('recurrentName').value = t.name; 
            document.getElementById('recurrentAmount').value = t.amount; 
            document.getElementById('recurrentAccount').value = t.account;
            populateSections('recurrentAccount', 'recurrentSection', 'recurrentSubsection'); 
            document.getElementById('recurrentSection').value = t.section || '';
            populateSubsections('recurrentAccount', 'recurrentSection', 'recurrentSubsection'); 
            document.getElementById('recurrentSubsection').value = t.subsection || '';
            document.getElementById('recurrentStartDate').value = t.startDate; 
            document.getElementById('recurrentEndDate').value = t.endDate; 
            document.getElementById('recurrentType').value = t.type || 'projected';
        }

        function deleteRecurrentTransaction(id) { 
            if (confirm("S√ªr de vouloir supprimer cette r√®gle ? Ceci va aussi supprimer les op√©rations automatiques associ√©es qui n'ont pas √©t√© modifi√©es manuellement.")) { 
                const list = appData.years[appData.currentYear].recurrentTransactions; 
                const i = list.findIndex(t => t.id === id); 
                if (i > -1) { 
                    list.splice(i, 1); 
                    renderRecurrentList(); 
                    applyRecurrentTransactions(); 
                    renderAll(); 
                } 
            } 
        }

        function clearRecurrentForm() { 
            appData.editingRecurrent = null; 
            document.getElementById('recurrentFormTitle').textContent = "Ajouter une Op√©ration R√©currente"; 
            document.getElementById('addOrUpdateRecurrentButton').textContent = 'Ajouter'; 
            ['recurrentName', 'recurrentAmount', 'recurrentStartDate', 'recurrentEndDate'].forEach(id => document.getElementById(id).value = ''); 
            document.getElementById('recurrentType').value = 'projected'; 
        }

        /**
         * Applique toutes les r√®gles de r√©currence pour l'ann√©e en cours
         * C'est une fonction cl√© qui est appel√©e √† chaque changement d'ann√©e ou modification des r√®gles
         * Elle supprime les anciennes op√©rations auto-g√©n√©r√©es et en cr√©e de nouvelles
        */
        function applyRecurrentTransactions() {
            const yearData = appData.years[appData.currentYear]; 
            if (!yearData) return;
            // Assure que les conteneurs existent
            if (!yearData.projected) yearData.projected = {}; 
            if (!yearData.actual) yearData.actual = {};
            // Nettoyage : supprime toutes les op√©rations qui ont √©t√© pr√©c√©demment auto-g√©n√©r√©es
            Object.keys(yearData.projected).forEach(k => { if (yearData.projected[k].autoGenerated) delete yearData.projected[k]; });
            Object.keys(yearData.actual).forEach(k => { if (yearData.actual[k].autoGenerated) delete yearData.actual[k]; });
            // Application : parcourt chaque r√®gle de r√©currence
            (yearData.recurrentTransactions || []).forEach(rule => {
                const targetType = rule.type || 'projected'; // Le type d'op√©ration √† cr√©er ('actual' ou 'projected')
                // V√©rifie les dates de d√©but et de fin de la r√®gle
                const start = rule.startDate ? new Date(rule.startDate + '-02T00:00:00') : null;
                const end = rule.endDate ? new Date(rule.endDate + '-02T00:00:00') : null;
                // Boucle sur les 12 mois de l'ann√©e
                for (let i = 0; i < 12; i++) {
                    // V√©rifie si la r√®gle est active pour ce mois
                    const monthDate = new Date(appData.currentYear, i, 15);
                    let isActive = true; 
                    if (start && monthDate < start) isActive = false; 
                    if (end && monthDate > end) isActive = false;
                    if (isActive) {
                        // V√©rifie si une op√©ration manuelle (r√©elle) a d√©j√† √©t√© cr√©√©e pour cette r√©currence ce mois-ci
                        // Cela permet de remplacer une projection par une d√©pense r√©elle
                        let isRealized = Object.values(yearData.actual).some(a => a.recurrentSourceId === rule.id && a.months[i] !== 0);
                        if (isRealized) continue; // Si c'est le cas, on ne cr√©e pas l'op√©ration auto
                        // Cr√©e la nouvelle op√©ration auto-g√©n√©r√©e
                        const id = `auto_${rule.id}_${i}`;
                        const newAction = { 
                            id, 
                            name: rule.name, 
                            account: rule.account, 
                            section: rule.section, 
                            subsection: rule.subsection, 
                            months: Array(12).fill(0), 
                            autoGenerated: true, // Marqueur pour savoir qu'elle est automatique
                            recurrentSourceId: rule.id, // Lien vers la r√®gle d'origine
                            type: targetType 
                        };
                        newAction.months[i] = rule.amount; // Applique le montant pour le mois en cours
                        yearData[targetType][id] = newAction; // Ajoute l'op√©ration √† `appData`
                    }
                }
            });
        }
        

        // --- PROJECTION sur 2 ans ---

        function showProjectionModal() {
            const modal = document.getElementById('projectionModal');
            const contentDiv = document.getElementById('projectionContent');
            contentDiv.innerHTML = "<p style='text-align:center; padding: 40px;'>G√©n√©ration de la projection en cours...</p>";
            modal.style.display = 'block';
            setTimeout(() => {
                const projectionData = generateProjectionData();
                contentDiv.innerHTML = generateProjectionContent(projectionData);
                createProjectionChart(projectionData);
            }, 50);
        }

        function generateProjectionData() {
            const startYear = appData.currentYear;
            const endYear = startYear + 1;
            const yearData = appData.years[startYear];
            if (!yearData) return null;
            const today = new Date();
            const currentMonthIndex = today.getMonth();
            const currentFullYear = today.getFullYear();
            let labels = [];
            let monthlyIncome = Array(24).fill(0);
            let monthlyExpenses = Array(24).fill(0);
            let pointTypes = Array(24).fill('projected'); // Par d√©faut, tout est projet√©

            // --- Ann√©e en cours ---
            const allActionsCurrentYear = getActionsForCurrentYear();
            for (let i = 0; i < 12; i++) {
                labels.push(`${months[i]} ${String(startYear).slice(2)}`);
                let actionsForMonth = [];
                if (startYear < currentFullYear) {
                    pointTypes[i] = 'real';
                    actionsForMonth = allActionsCurrentYear.filter(a => a.type === 'actual' && a.months[i] !== 0);
                } else if (startYear === currentFullYear) {
                    if (i < currentMonthIndex) {
                        pointTypes[i] = 'real';
                        actionsForMonth = allActionsCurrentYear.filter(a => a.type === 'actual' && a.months[i] !== 0);
                    } else if (i === currentMonthIndex) {
                        pointTypes[i] = 'current';
                        actionsForMonth = allActionsCurrentYear.filter(a => a.months[i] !== 0);
                    } else {
                        pointTypes[i] = 'projected';
                        const actualsInMonth = allActionsCurrentYear.filter(a => a.type === 'actual' && a.months[i] !== 0);
                        actionsForMonth = actualsInMonth.length > 0 ? actualsInMonth : allActionsCurrentYear.filter(a => a.type === 'projected' && a.months[i] !== 0);
                    }
                } else {
                    pointTypes[i] = 'projected';
                    const actualsInMonth = allActionsCurrentYear.filter(a => a.type === 'actual' && a.months[i] !== 0);
                    actionsForMonth = actualsInMonth.length > 0 ? actualsInMonth : allActionsCurrentYear.filter(a => a.type === 'projected' && a.months[i] !== 0);
                }
                actionsForMonth.forEach(a => {
                    if (a.isTransfer) return;
                    const amount = a.months[i];
                    if (amount > 0) monthlyIncome[i] += amount;
                    else monthlyExpenses[i] += Math.abs(amount);
                });
            }

            // --- Ann√©e suivante ---
            const recurrentRules = yearData.recurrentTransactions || [];
            for (let i = 0; i < 12; i++) {
                const monthIndexInArray = i + 12;
                labels.push(`${months[i]} ${String(endYear).slice(2)}`);
                pointTypes[monthIndexInArray] = 'projected';
                recurrentRules.forEach(rule => {
                    const monthDate = new Date(endYear, i, 15);
                    const start = rule.startDate ? new Date(rule.startDate + '-02T00:00:00') : null;
                    const end = rule.endDate ? new Date(rule.endDate + '-02T00:00:00') : null;
                    let isActive = true;
                    if (start && monthDate < start) isActive = false;
                    if (end && monthDate > end) isActive = false;
                    if (isActive) {
                        if (rule.amount > 0) monthlyIncome[monthIndexInArray] += rule.amount;
                        else monthlyExpenses[monthIndexInArray] += Math.abs(rule.amount);
                    }
                });
            }

            // --- Calculs finaux ---
            let totalStartingBalance = 0;
            (yearData.structure.accounts || []).forEach(acc => {
                totalStartingBalance += getStartingBalance(acc.id);
            });
            let monthlyBalance = Array(24).fill(0);
            let cumulativeBalance = Array(24).fill(0);
            for (let i = 0; i < 24; i++) {
                monthlyBalance[i] = monthlyIncome[i] - monthlyExpenses[i];
                if (i === 0) {
                    cumulativeBalance[i] = totalStartingBalance + monthlyBalance[i];
                } else {
                    cumulativeBalance[i] = cumulativeBalance[i - 1] + monthlyBalance[i];
                }
            }

            return { labels, monthlyIncome, monthlyExpenses, monthlyBalance, cumulativeBalance, pointTypes };
        }

        function generateProjectionContent(data) {
            if (!data) return "<p>Impossible de g√©n√©rer la projection. Assurez-vous que l'ann√©e en cours est correctement configur√©e.</p>";
            let tableHtml = `<div class="table-container" style="max-height: 40vh; margin-bottom: 20px;">
                                <table class="financial-table">
                                    <thead>
                                        <tr><th>Indicateur</th>${data.labels.map(l => `<th>${l}</th>`).join('')}</tr>
                                    </thead>
                                    <tbody>
                                        <tr><td><strong>Revenus</strong></td>${data.monthlyIncome.map(v => `<td class="amount-positive">${v.toFixed(2)}‚Ç¨</td>`).join('')}</tr>
                                        <tr><td><strong>D√©penses</strong></td>${data.monthlyExpenses.map(v => `<td class="amount-negative">${v.toFixed(2)}‚Ç¨</td>`).join('')}</tr>
                                        <tr class="section-total-row"><td><strong>Solde Mensuel</strong></td>${data.monthlyBalance.map(v => `<td class="${v >= 0 ? 'amount-positive' : 'amount-negative'}">${v.toFixed(2)}‚Ç¨</td>`).join('')}</tr>
                                        <tr class="balance-row"><td><strong>Solde Cumul√©</strong></td>${data.cumulativeBalance.map(v => `<td class="${v >= 0 ? 'amount-positive' : 'amount-negative'}">${v.toFixed(2)}‚Ç¨</td>`).join('')}</tr>
                                    </tbody>
                                </table>
                             </div>`;
            let chartHtml = `<h3>√âvolution du Solde Projet√©</h3><canvas id="projectionChartCanvas"></canvas>`;
            return tableHtml + chartHtml;
        }

        function createProjectionChart(data) {
            if (!data) return;
            const ctx = document.getElementById('projectionChartCanvas');
            if (!ctx) return;
            if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
            const realColor = getCssVariable('--success-color');
            const currentColor = getCssVariable('--warning-color');
            const projectedColor = getCssVariable('--secondary-color-dark');
            const primaryColor = getCssVariable('--primary-color');
            const pointBackgroundColors = data.pointTypes.map(type => {
                switch (type) {
                    case 'real': return realColor;
                    case 'current': return currentColor;
                    case 'projected': return projectedColor;
                    default: return primaryColor;
                }
            });
            const pointRadii = data.pointTypes.map(type => type === 'current' ? 6 : 4);
            const pointBorderWidths = data.pointTypes.map(type => type === 'current' ? 3 : 1);
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Solde Cumul√© Projet√©',
                        data: data.cumulativeBalance,
                        borderColor: primaryColor,
                        backgroundColor: 'rgba(13, 71, 161, 0.2)',
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: pointBackgroundColors,
                        pointBorderColor: pointBackgroundColors,
                        pointRadius: pointRadii,
                        pointBorderWidth: pointBorderWidths,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: {
                        y: { ticks: { callback: v => v.toFixed(0) + '‚Ç¨' } }
                    }
                }
            });
        }


        // --- MODAL CONTROLS ---

        /**
         * Ferme une fen√™tre modale sp√©cifi√©e
         * @param {string} modalId - L'ID de la modale √† fermer
        */
        function closeModal(modalId) { 
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'transferModal') {
                appData.editingTransferId = null;
            }
        }

        /**
         * Permet de fermer les modales en cliquant √† l'ext√©rieur de leur contenu.
        */
        window.onclick = function(event) { 
            document.querySelectorAll('.modal').forEach(m => { if (event.target === m) closeModal(m.id); }); 
        }
        
        /**
         * √âcouteur d'√©v√©nement qui lance la fonction `init` une fois que tout le HTML est charg√©
         * C'est le point de d√©part de l'application
        */
        document.addEventListener('DOMContentLoaded', init);

    </script>

</body>

</html>