<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Budget Sécurisé</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #FAF8F1; /* Warm Beige Background */
            color: #5D4037; /* Dark Brown Text */
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #FFA726, #81C784); /* Orange to Green Gradient */
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 350px;
        }

        .login-form h1 {
            color: #F57C00; /* Primary Orange */
            margin-bottom: 30px;
            font-weight: 700;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #D7CCC8; /* Warm Gray Border */
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: #F57C00; /* Primary Orange */
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #F57C00; /* Primary Orange */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px 0;
        }

        .login-btn:hover {
            background: #E65100; /* Darker Orange */
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            width: 100%;
            padding: 12px;
            background: #81C784; /* Natural Green */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px 0;
            text-align: center;
        }

        .file-label:hover {
            background: #66BB6A; /* Darker Green */
        }

        .login-options {
            margin: 20px 0;
            padding: 20px 0;
            border-top: 1px solid #D7CCC8; /* Warm Gray Border */
        }

        .login-options h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 16px;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #F57C00; /* Primary Orange */
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #F57C00; /* Primary Orange */
            color: white;
        }

        .btn-primary:hover {
            background: #E65100; /* Darker Orange */
        }

        .btn-success {
            background: #81C784; /* Natural Green */
            color: white;
        }

        .btn-success:hover {
            background: #66BB6A; /* Darker Green */
        }

        .btn-danger {
            background: #EF5350;
            color: white;
        }

        .btn-danger:hover {
            background: #E53935;
        }
        
        .btn-secondary {
            background: #B0BEC5; /* Blue Grey */
            color: white;
        }
        .btn-secondary:hover {
            background: #78909C;
        }


        .btn-warning {
            background: #FFA726; /* Amber */
            color: white;
        }

        .btn-warning:hover {
            background: #FB8C00;
        }

        /* Year Tabs */
        .year-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .year-tab {
            padding: 12px 20px;
            background: white;
            border: 2px solid #D7CCC8;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .year-tab.active {
            background: #F57C00; /* Primary Orange */
            color: white;
            border-color: #F57C00;
        }

        .year-tab:hover:not(.active) {
            border-color: #F57C00;
            background: #fff;
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 20px;
        }

        /* Financial Table */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .financial-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .financial-table th {
            background: #F57C00; /* Primary Orange */
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #ddd;
        }

        .financial-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
            font-size: 14px;
        }
        
        .financial-table td:first-child {
            font-weight: 500;
            text-align: left;
            padding-left: 15px; /* Indent cell content */
        }

        .financial-table tr:nth-child(even) {
            background: #FFF8E1; /* Light Beige for even rows */
        }

        .financial-table tr.subsection-row:hover {
            background: #FFE0B2; /* Light Orange hover */
        }

        .account-header {
            background: #FB8C00 !important; /* Lighter Orange */
            font-weight: 700;
        }

        .section-header {
            background: #FFCC80 !important; /* Light Orange */
            font-weight: 600;
            text-align: left !important;
            padding-left: 20px !important;
            color: #5D4037; /* Dark text for readability */
        }

        .financial-table td.category-cell-no-section {
            padding-left: 30px !important;
            font-style: italic;
            color: #777;
        }
        
        .action-item {
            cursor: pointer;
            padding: 4px 2px;
            border-radius: 4px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        .action-item:hover {
            background-color: #FFE0B2; /* Light Orange hover */
        }
        .action-item span:first-child {
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .recurrent-marker {
            font-style: italic;
            color: #8D6E63;
            font-size: 11px;
            display: block;
        }

        .amount-positive {
            color: #388E3C;
            font-weight: 600;
        }

        .amount-negative {
            color: #D32F2F;
            font-weight: 600;
        }
        
        .section-total-row td {
            background: #FFE0B2 !important; /* Light orange */
            font-weight: 700;
            text-align: right;
            color: #5D4037; /* Dark text for readability */
            vertical-align: middle;
        }
        .section-total-row td:first-child {
            text-align: left;
        }

        .balance-row td {
            background: #FFF3E0 !important; /* Very Light Orange */
            font-weight: 700;
            border-top: 2px solid #F57C00 !important;
            text-align: right;
        }
        .balance-row td:first-child {
            text-align: left;
        }

        .grand-total-balance-row td {
            background-color: #FFCC80 !important; /* Light Orange */
            font-weight: 700;
            font-size: 16px !important;
            border-top: 3px solid #FB8C00 !important;
            text-align: right;
        }
        .grand-total-balance-row td:first-child {
            text-align: left;
        }

        /* Add Action Form */
        .add-action-form, .transfer-form, .recurrent-form {
            background: #FFF8E1; /* Light Beige */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #D7CCC8;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #5D4037;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #D7CCC8;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #F57C00;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        /* Stats */
        #statsModal .financial-table { min-width: 0; }
        #statsModal .financial-table th, #statsModal .financial-table td { text-align: center; padding: 12px 8px; }
        #statsModal .financial-table td.category-name-cell { font-style: italic; color: #555; font-size: 13px; text-align: left; }
        #statsModal .financial-table td.budget-status { font-weight: bold; }


        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        /* Structure Management */
        .structure-item {
            background: #FFF8E1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #F57C00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .structure-item-name {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .structure-item.account { border-left-color: #F57C00; }
        .structure-item.section { border-left-color: #FB8C00; margin-left: 20px; }
        .structure-item.subsection { border-left-color: #FFCC80; margin-left: 40px; }

        .structure-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Budget Input in Structure Manager */
        .budget-input {
            width: 100px;
            padding: 5px;
            text-align: right;
            border: 1px solid #D7CCC8;
            border-radius: 5px;
        }
        .budget-input:focus {
            outline: none;
            border-color: #F57C00;
        }
        
        /* Progress Bar for Budget */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
        }
        .progress-bar.green { background-color: #66BB6A; }
        .progress-bar.orange { background-color: #FFA726; }
        .progress-bar.red { background-color: #EF5350; }
        .progress-bar.grey { background-color: #BDBDBD; }
        .budget-text {
            font-size: 12px;
            color: #777;
        }

        .starting-balance-form { background: #FFF3E0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #F57C00; }
        .balance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .balance-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid #D7CCC8; }
        .balance-item label { font-weight: 600; color: #5D4037; }
        .balance-item input { width: 120px; padding: 8px; border: 2px solid #D7CCC8; border-radius: 6px; text-align: right; }
        .balance-item input:focus { outline: none; border-color: #F57C00; }

        .auto-save-indicator { position: fixed; top: 20px; right: 20px; background: #81C784; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; opacity: 0; transition: opacity 0.3s; z-index: 1001; }
        .auto-save-indicator.show { opacity: 1; }
        .hidden { display: none; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { flex-direction: column; gap: 10px; }
            .year-tabs { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; margin: 10% auto; padding: 20px; }
            .login-form { min-width: 300px; }
        }
    </style>
</head>
<body>
    <div id="autoSaveIndicator" class="auto-save-indicator">
        💾 Données Enregistrées
    </div>

    <div id="loginScreen" class="login-screen">
        <div class="login-form">
            <h1>🔒 Mon Budget Sécurisé</h1>
            <p style="margin-bottom: 20px; font-size: 14px; color: #555;">Toutes les données sont maintenant chiffrées.</p>
            <div>
                <input type="password" id="passwordInput" placeholder="Entrez votre mot de passe" />
                <button class="login-btn" onclick="login()">Accéder au Registre</button>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    Première visite ? Votre mot de passe sera défini et utilisé pour chiffrer vos données.
                </p>
            </div>
            <div class="login-options">
                <h3>Charger des Données Existantes</h3>
                <input type="file" id="dataFileInput" accept=".json" class="file-input" onchange="loadDataFile()">
                <label for="dataFileInput" class="file-label">📁 Charger un Fichier de Données</label>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Sélectionnez votre fichier .json chiffré ou non-chiffré.
                </p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="header">
                <div class="logo">🔒 Mon Budget</div>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="saveDataFile()">💾 Sauvegarder</button>
                    <button class="btn btn-warning" onclick="exportData()">📄 Exporter CSV</button>
                    <button class="btn btn-primary" onclick="showStats()">📊 Statistiques</button>
                    <button class="btn btn-primary" onclick="showRecurrentModal()">🔄 Gérer Récurrences</button>
                    <button class="btn btn-primary" onclick="showStructureManager()">⚙️ Structure & Budgets</button>
                    <button class="btn btn-danger" onclick="logout()">🚪 Déconnexion</button>
                </div>
            </div>

            <div class="year-tabs" id="yearTabs"></div>

            <div class="main-content">
                <div class="starting-balance-form">
                    <h3>💰 Soldes Initiaux des Comptes pour <span id="balanceYear"></span></h3>
                    <div class="balance-grid" id="balanceGrid"></div>
                </div>

                <div class="add-action-form" id="addActionForm" style="display: none;">
                    <h3 id="formTitle">Ajouter une Nouvelle Opération</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Nom de l'Opération</label><input type="text" id="actionName" placeholder="Ex: Courses, Restaurant..."></div>
                        <div class="form-group"><label>Compte</label><select id="actionAccount"></select></div>
                        <div class="form-group"><label>Section</label><select id="actionSection"></select></div>
                        <div class="form-group"><label>Sous-section</label><select id="actionSubsection"></select></div>
                        <div class="form-group"><label>Mois</label><select id="actionMonth"><option value="0">Janvier</option><option value="1">Février</option><option value="2">Mars</option><option value="3">Avril</option><option value="4">Mai</option><option value="5">Juin</option><option value="6">Juillet</option><option value="7">Août</option><option value="8">Septembre</option><option value="9">Octobre</option><option value="10">Novembre</option><option value="11">Décembre</option></select></div>
                        <div class="form-group"><label>Montant</label><input type="number" id="actionAmount" placeholder="Montant (+ ou -)" step="0.01"></div>
                        <div class="form-group"><label>Type</label><select id="actionType"><option value="actual">Réel</option><option value="projected">Projeté</option></select></div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="addOrUpdateButton" class="btn btn-primary" onclick="addAction()">Ajouter l'Opération</button>
                        <button class="btn btn-danger" id="deleteActionButton" onclick="deleteAction()" style="display: none;">Supprimer l'Opération</button>
                        <button class="btn" onclick="hideAddActionForm()" style="background: #ccc;">Annuler</button>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="btn btn-primary" onclick="showAddActionForm()">+ Ajouter Opération</button>
                    <button class="btn btn-primary" onclick="showTransferModal()" style="background-color: #5C6BC0;">Virement Inter-compte</button>
                    <button class="btn btn-success" onclick="addNewYear()">+ Ajouter Année</button>
                    <button class="btn btn-danger" onclick="deleteCurrentYear()">- Supprimer Année</button>
                    <button class="btn btn-secondary" onclick="collapseAll()">Tout Réduire</button>
                    <button class="btn btn-secondary" onclick="expandAll()">Tout Développer</button>
                </div>

                <div class="table-container">
                    <table class="financial-table" id="financialTable"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="statsModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="stats-modal-title">Statistiques Financières</h2><span class="close" onclick="closeModal('statsModal')">×</span></div><div id="statsContent"></div></div></div>
    <div id="structureModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Gérer la Structure et les Budgets</h2><span class="close" onclick="closeModal('structureModal')">×</span></div><div id="structureContent"></div></div></div>
    
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Effectuer un Virement Inter-compte</h2><span class="close" onclick="closeModal('transferModal')">×</span></div>
            <div class="transfer-form">
                <div class="form-grid">
                    <div class="form-group"><label>Nom du virement</label><input type="text" id="transferName" placeholder="Ex: Épargne mensuelle"></div>
                    <div class="form-group"><label>Compte à Débiter</label><select id="transferSourceAccount"></select></div>
                    <div class="form-group"><label>Compte à Créditer</label><select id="transferDestAccount"></select></div>
                    <div class="form-group"><label>Mois</label><select id="transferMonth"><option value="0">Janvier</option><option value="1">Février</option><option value="2">Mars</option><option value="3">Avril</option><option value="4">Mai</option><option value="5">Juin</option><option value="6">Juillet</option><option value="7">Août</option><option value="8">Septembre</option><option value="9">Octobre</option><option value="10">Novembre</option><option value="11">Décembre</option></select></div>
                    <div class="form-group"><label>Somme</label><input type="number" id="transferAmount" placeholder="Montant du virement" step="0.01"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="addTransfer()">Effectuer le Virement</button>
                    <button class="btn" onclick="closeModal('transferModal')" style="background: #ccc;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <div id="recurrentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Gérer les Opérations Récurrentes</h2><span class="close" onclick="closeModal('recurrentModal')">×</span></div>
            <p style="margin-bottom:20px; font-style:italic;">Ces opérations seront automatiquement ajoutées en "Projeté" pour chaque mois de l'année en cours.</p>
            
            <div class="recurrent-form">
                <h3 id="recurrentFormTitle">Ajouter une Opération Récurrente</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nom (optionnel)</label><input type="text" id="recurrentName" placeholder="Ex: Loyer, Netflix..."></div>
                    <div class="form-group"><label>Compte</label><select id="recurrentAccount"></select></div>
                    <div class="form-group"><label>Section</label><select id="recurrentSection"></select></div>
                    <div class="form-group"><label>Sous-section</label><select id="recurrentSubsection"></select></div>
                    <div class="form-group"><label>Montant Mensuel</label><input type="number" id="recurrentAmount" placeholder="Montant (+ ou -)" step="0.01"></div>
                    <div class="form-group"><label>Date de début (AAAA-MM)</label><input type="month" id="recurrentStartDate"></div>
                    <div class="form-group"><label>Date de fin (AAAA-MM, optionnel)</label><input type="month" id="recurrentEndDate"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="addOrUpdateRecurrentButton" class="btn btn-primary" onclick="saveRecurrentTransaction()">Ajouter</button>
                    <button class="btn" onclick="clearRecurrentForm()" style="background: #ccc;">Annuler</button>
                </div>
            </div>

            <div id="recurrentList" style="margin-top: 30px;"></div>
        </div>
    </div>


    <script>
        // --- GLOBAL VARIABLES ---
        let appData = {
            password: null, 
            years: {},
            currentYear: new Date().getFullYear(),
            editingAction: null,
            editingRecurrent: null
        };
        let uiState = { collapsed: {} };
        let structureUiState = { collapsed: {} };
        const months = ['Janv', 'Févr', 'Mars', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sept', 'Oct', 'Nov', 'Déc'];
        const VIREMENT_SECTION_ID = 'internal_transfers';
        const VIREMENT_SECTION_NAME = 'Virements Inter-comptes';

        // --- CORE APP & ENCRYPTION ---
        function init() {
            if (!appData.years[appData.currentYear]) {
                appData.years[appData.currentYear] = createNewYearData();
            }
        }
        function createNewYearData(structureToCopy = null) {
            const defaultStructure = {
                accounts: [{ id: 'account1', name: 'Compte Principal', sections: [
                    { id: 'income', name: 'Revenus', budget: 0, subsections: [ { id: 'salary', name: 'Salaire', budget: 0 } ]},
                    { id: 'expenses', name: 'Dépenses', budget: 0, subsections: [ { id: 'rent', name: 'Loyer', budget: 0 }, { id: 'food', name: 'Nourriture', budget: 0 } ]}
                ]}]
            };
            return {
                actual: {},
                projected: {},
                startingBalances: {},
                recurrentTransactions: [],
                structure: structureToCopy ? JSON.parse(JSON.stringify(structureToCopy)) : defaultStructure
            };
        }
        
        function saveDataFile() {
            if (!appData.password) {
                alert("Erreur : Aucun mot de passe n'est défini pour chiffrer les données.");
                return;
            }
            try {
                const dataToSave = { years: appData.years };
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(dataToSave), appData.password).toString();
                const finalFileObject = { encryptedData: encrypted };
                const d = JSON.stringify(finalFileObject, null, 2);
                const b = new Blob([d], { type: 'application/json' });
                const u = URL.createObjectURL(b);
                const a = document.createElement('a');
                a.href = u;
                a.download = `mon-budget-sauvegarde-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(u);
                showAutoSaveIndicator();
            } catch (err) {
                console.error("Erreur de chiffrement:", err);
                alert("Une erreur est survenue lors du chiffrement des données.");
            }
        }

        function loadDataFile() {
            const f = document.getElementById('dataFileInput').files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const p = prompt('Entrez le mot de passe pour ce fichier de données :');
                if (!p) return;

                try {
                    const fileContent = JSON.parse(e.target.result);
                    let decryptedDataString;

                    if (fileContent.encryptedData) {
                        const decryptedBytes = CryptoJS.AES.decrypt(fileContent.encryptedData, p);
                        decryptedDataString = decryptedBytes.toString(CryptoJS.enc.Utf8);
                        if (!decryptedDataString) throw new Error("Decryption failed. Wrong password?");
                    } else {
                        console.warn("Chargement d'un fichier non-chiffré. Il sera chiffré à la prochaine sauvegarde.");
                        decryptedDataString = JSON.stringify(fileContent);
                    }
                    
                    let parsedData = JSON.parse(decryptedDataString);
                    let migratedData = migrateData(parsedData);
                    
                    appData.years = migratedData.years;
                    appData.password = p;

                    showMainApp();
                    alert('Données chargées avec succès !');

                } catch (err) {
                    console.error("Erreur lors de la lecture/déchiffrement du fichier :", err);
                    alert('Erreur: Mot de passe incorrect ou fichier corrompu.');
                }
            };
            r.readAsText(f);
        }
        
        function login() {
            const p = document.getElementById('passwordInput').value;
            if (!p) return alert('Veuillez entrer un mot de passe');
            if (!appData.password) { appData.password = p; showMainApp(); alert('Mot de passe défini ! Pensez à sauvegarder votre fichier pour l\'enregistrer de manière chiffrée.'); }
        }
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            if (!appData.years[appData.currentYear]) {
                appData.currentYear = Object.keys(appData.years).sort((a, b) => b - a)[0] || new Date().getFullYear();
                if (!appData.years[appData.currentYear]) {
                    appData.years[appData.currentYear] = createNewYearData();
                }
            }
            resetUiState();
            generateProjectedFromRecurrent();
            renderAll();
        }
        function renderAll() {
            renderYearTabs();
            renderTable();
            renderStartingBalances();
            populateFormDropdowns();
        }
        
        function migrateData(data) {
            if (data.structure) {
                console.log("Migration de l'ancien format de données en cours...");
                Object.keys(data.years).forEach(year => { if (!data.years[year].structure) { data.years[year].structure = JSON.parse(JSON.stringify(data.structure)); } });
                delete data.structure;
            }
            Object.keys(data.years).forEach(year => {
                const yearData = data.years[year];
                if (yearData.structure) { yearData.structure = migrateStructureToArrayFormat(yearData.structure); }
                if (!yearData.recurrentTransactions) { yearData.recurrentTransactions = []; }
            });
            return data;
        }

        function migrateStructureToArrayFormat(structure) {
            if (!structure || (structure.accounts && Array.isArray(structure.accounts))) {
                structure.accounts.forEach(acc => {
                    acc.sections.forEach(sec => {
                        if (sec.budget === undefined) sec.budget = 0;
                        sec.subsections.forEach(sub => { if (sub.budget === undefined) sub.budget = 0; });
                    });
                });
                return structure;
            }
            console.log("Migration de la structure vers un format de tableau...");
            const newAccounts = Object.keys(structure.accounts).map(accId => {
                const account = structure.accounts[accId];
                const newSections = Object.keys(account.sections).map(secId => {
                    const section = account.sections[secId];
                    const newSubsections = Object.keys(section.subsections).map(subId => ({ id: subId, name: section.subsections[subId].name, budget: 0 }));
                    return { id: secId, name: section.name, subsections: newSubsections, budget: 0 };
                });
                return { id: accId, name: account.name, sections: newSections };
            });
            return { accounts: newAccounts };
        }
        
        function logout() {
            if (confirm('Voulez-vous sauvegarder vos données (chiffrées) avant de vous déconnecter ?')) { saveDataFile(); }
            appData = { password: null, years: {}, currentYear: new Date().getFullYear(), editingAction: null, editingRecurrent: null };
            init();
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('dataFileInput').value = '';
        }
        function showAutoSaveIndicator() { const i = document.getElementById('autoSaveIndicator'); i.classList.add('show'); setTimeout(() => i.classList.remove('show'), 2000); }
        function getCurrentStructure() { return appData.years[appData.currentYear]?.structure; }
        function resetUiState() { uiState.collapsed = {}; }
        function getActionsForCurrentYear() { const d = appData.years[appData.currentYear] || { actual: {}, projected: {} }; const a = []; ['actual', 'projected'].forEach(t => { Object.values(d[t] || {}).forEach(ac => a.push({ ...ac, type: t })); }); return a; }
        // CORRIGÉ: Fonction pour ne récupérer que les opérations réelles pour les stats
        function getActualActionsForCurrentYear() { const d = appData.years[appData.currentYear]; if (!d || !d.actual) return []; return Object.values(d.actual).map(a => ({ ...a, type: 'actual' })); }

        // --- UI & TABLE RENDERING ---
        function renderYearTabs() { const c = document.getElementById('yearTabs'); c.innerHTML = ''; const y = Object.keys(appData.years).sort((a,b)=>parseInt(b)-parseInt(a)); y.forEach(y => { const t = document.createElement('div'); t.className = `year-tab ${y == appData.currentYear ? 'active' : ''}`; t.textContent = y; t.onclick = () => switchYear(y); c.appendChild(t); }); }
        function switchYear(y) { appData.currentYear = parseInt(y); resetUiState(); generateProjectedFromRecurrent(); renderAll(); }
        function addNewYear() {
            const y = prompt("Entrez l'année (AAAA) :");
            if (y && /^\d{4}$/.test(y)) {
                const i = parseInt(y);
                if (!appData.years[i]) {
                    appData.years[i] = createNewYearData(getCurrentStructure());
                    appData.currentYear = i; resetUiState(); generateProjectedFromRecurrent(); renderAll();
                }
            }
        }
        function deleteCurrentYear() {
            const yearKeys = Object.keys(appData.years);
            if (yearKeys.length <= 1) { alert("Impossible de supprimer la dernière année restante."); return; }
            if (confirm(`Êtes-vous sûr(e) de vouloir supprimer définitivement l'année ${appData.currentYear} et toutes ses données ?`)) {
                delete appData.years[appData.currentYear];
                const remainingYears = Object.keys(appData.years).sort((a,b) => parseInt(b) - parseInt(a));
                switchYear(parseInt(remainingYears[0]));
                alert(`L'année a été supprimée. Affichage de l'année ${appData.currentYear}.`); showAutoSaveIndicator();
            }
        }
        
        function toggleAccountCollapse(accountId) { uiState.collapsed[accountId] = !uiState.collapsed[accountId]; renderTable(); }
        function toggleSectionCollapse(sectionId) { uiState.collapsed[sectionId] = !uiState.collapsed[sectionId]; renderTable(); }
        function collapseAll() { const s=getCurrentStructure(); if(!s) return; s.accounts.forEach(a=>{uiState.collapsed[a.id]=true; a.sections.forEach(c=>uiState.collapsed[c.id]=true);}); renderTable(); }
        function expandAll() { resetUiState(); renderTable(); }

        function renderTable() {
            const table = document.getElementById('financialTable');
            table.innerHTML = '';
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Catégorie</th>' + months.map(m => `<th>${m}</th>`).join('');
            table.appendChild(headerRow);
            const allActions = getActionsForCurrentYear();
            const structure = getCurrentStructure();
            if (!structure || !structure.accounts) return;

            structure.accounts.forEach(account => {
                const isAccountCollapsed = uiState.collapsed[account.id];
                const accountToggleIcon = isAccountCollapsed ? '▶' : '▼';
                const accountRow = document.createElement('tr');
                accountRow.innerHTML = `<th class="account-header" colspan="13" onclick="toggleAccountCollapse('${account.id}')" style="cursor: pointer;">${accountToggleIcon} ${account.name}</th>`;
                table.appendChild(accountRow);

                if (!isAccountCollapsed) {
                    renderSubsectionRow(table, account.id, "", "", { name: '<em>(Opérations sans section)</em>' }, allActions);
                    account.sections.forEach(section => {
                        const isSectionCollapsed = uiState.collapsed[section.id];
                        const sectionToggleIcon = isSectionCollapsed ? '▶' : '▼';
                        const sectionRow = document.createElement('tr');
                        sectionRow.innerHTML = `<th class="section-header" colspan="13" onclick="toggleSectionCollapse('${section.id}')" style="cursor: pointer;">${sectionToggleIcon} ${section.name}</th>`;
                        table.appendChild(sectionRow);
                        
                        if (!isSectionCollapsed) {
                            renderSubsectionRow(table, account.id, section.id, "", { name: '<em>(Opérations sans sous-section)</em>' }, allActions);
                            section.subsections.forEach(subsection => {
                                renderSubsectionRow(table, account.id, section.id, subsection.id, subsection, allActions);
                                renderCategoryTotalRow(table, account.id, section.id, subsection.id, subsection, allActions, true);
                            });
                            renderCategoryTotalRow(table, account.id, section.id, null, section, allActions, false);
                        }
                    });
                    renderAccountBalanceRow(table, account.id, account, allActions);
                }
            });
            renderGrandTotalBalanceRow(table, allActions);
        }

        function renderSubsectionRow(table, accountId, sectionId, subsectionId, subsection, allActions) {
            const relevantActions = allActions.filter(a => a.account === accountId && (a.section || "") === sectionId && (a.subsection || "") === subsectionId);
            if(relevantActions.length === 0 && !subsection.id) return;
            const row = document.createElement('tr'); 
            row.classList.add('subsection-row'); 
            let html = `<td>${subsection.name}</td>`;
            if (!subsection.id) { html = `<td class="category-cell-no-section">${subsection.name}</td>`; }
            for (let i = 0; i < 12; i++) {
                const actionsInMonth = relevantActions.filter(a => a.months[i] !== 0);
                html += `<td>${actionsInMonth.map(a => `<div class="action-item" onclick="editAction('${a.id}', '${a.type}')"><span>${(a.name || '')}${a.type==='projected'?' (P)':''}</span><span class="${a.months[i]>=0?'amount-positive':'amount-negative'}">${a.months[i].toFixed(2)}€</span>${a.autoGenerated ? '<span class=recurrent-marker>Auto</span>': ''}</div>`).join('')}</td>`;
            }
            row.innerHTML = html; table.appendChild(row);
        }
        
        function renderCategoryTotalRow(table, accountId, sectionId, subsectionId, category, allActions, isSubsection) {
            const budget = category.budget || 0;
            const row = document.createElement('tr');
            row.className = 'section-total-row';
            const totalLabel = isSubsection ? `Total ${category.name}` : `Total ${category.name}`;
            let html = `<td><strong>${totalLabel}</strong></td>`;
            
            for (let i = 0; i < 12; i++) {
                const totalAmount = allActions
                    .filter(a => a.account === accountId && a.section === sectionId && (!isSubsection || a.subsection === subsectionId))
                    .reduce((sum, a) => sum + a.months[i], 0);

                let budgetHtml;
                const isExpense = totalAmount < 0;
                const amountForCalc = isExpense ? Math.abs(totalAmount) : totalAmount;

                if (budget > 0) {
                    const percentage = Math.min(100, (amountForCalc / budget) * 100);
                    let colorClass = 'green';
                    if (percentage >= 100) colorClass = 'red';
                    else if (percentage >= 75) colorClass = 'orange';
                    budgetHtml = `
                        <div class="budget-text">${isExpense ? '-' : ''}${amountForCalc.toFixed(2)}€ / ${isExpense ? '-' : ''}${budget.toFixed(2)}€</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${colorClass}" style="width: ${percentage}%;"></div>
                        </div>`;
                } else {
                    const amountClass = totalAmount >= 0 ? 'amount-positive' : 'amount-negative';
                    budgetHtml = `<div class="${amountClass}">${totalAmount.toFixed(2)}€</div>
                                 <div class="progress-bar-container"><div class="progress-bar grey" style="width: 100%;"></div></div>`;
                }

                html += `<td>${budgetHtml}</td>`;
            }
            row.innerHTML = html;
            table.appendChild(row);
        }

        function renderAccountBalanceRow(table, accountId, account, allActions) {
            const row = document.createElement('tr'); row.className = 'balance-row'; let net = Array(12).fill(0);
            allActions.forEach(a => { if (a.account === accountId) a.months.forEach((amt, i) => { if (amt) net[i] += amt; }); });
            let bal = Array(12).fill(0); bal[0] = getStartingBalance(accountId) + net[0];
            for(let i=1; i<12; i++) bal[i] = bal[i-1] + net[i];
            let html = `<td><strong>Solde ${account.name}</strong></td>`; bal.forEach(b => html += `<td class="${b>=0?'amount-positive':'amount-negative'}">${b.toFixed(2)}€</td>`);
            row.innerHTML = html; table.appendChild(row);
        }
        function renderGrandTotalBalanceRow(table, allActions) {
            const row = document.createElement('tr'); row.className = 'grand-total-balance-row'; let totalBal = Array(12).fill(0);
            getCurrentStructure().accounts.forEach(account => {
                let net = Array(12).fill(0); allActions.forEach(a => { if (a.account === account.id) a.months.forEach((amt, i) => net[i] += amt); });
                let accBal = Array(12).fill(0); accBal[0] = getStartingBalance(account.id) + net[0];
                for(let i=1; i<12; i++) accBal[i] = accBal[i-1] + net[i];
                totalBal.forEach((_, i) => totalBal[i] += accBal[i]);
            });
            let html = `<td><strong>Solde Total</strong></td>`; totalBal.forEach(b => html += `<td class="${b>=0?'amount-positive':'amount-negative'}">${b.toFixed(2)}€</td>`);
            row.innerHTML = html; table.appendChild(row);
        }
        
        function renderStartingBalances() {
            const g = document.getElementById('balanceGrid');
            document.getElementById('balanceYear').textContent = appData.currentYear;
            g.innerHTML = '';
            const accounts = getCurrentStructure()?.accounts || [];
            accounts.forEach(a => {
                const i = document.createElement('div');
                i.className = 'balance-item';
                i.innerHTML = `<label>${a.name}</label><input type="number" value="${getStartingBalance(a.id)}" onchange="updateStartingBalance('${a.id}', this.value)">`;
                g.appendChild(i);
            });
        }
        function getStartingBalance(id) { if (!appData.years[appData.currentYear].startingBalances) appData.years[appData.currentYear].startingBalances = {}; return appData.years[appData.currentYear].startingBalances[id] || 0; }
        function updateStartingBalance(id, value) { appData.years[appData.currentYear].startingBalances[id] = parseFloat(value) || 0; renderTable(); }


        // --- FORMS & DATA MANIPULATION (Actions) ---
        function showAddActionForm() { document.getElementById('addActionForm').style.display = 'block'; document.getElementById('formTitle').textContent = 'Ajouter une Opération'; document.getElementById('addOrUpdateButton').textContent = 'Ajouter'; document.getElementById('deleteActionButton').style.display = 'none'; populateFormDropdowns(); clearActionForm(); }
        function hideAddActionForm() { document.getElementById('addActionForm').style.display = 'none'; appData.editingAction = null; clearActionForm(); }
        function clearActionForm() { ['actionName', 'actionAmount'].forEach(id => document.getElementById(id).value = ''); document.getElementById('actionMonth').value = new Date().getMonth(); document.getElementById('actionType').value = 'actual'; ['actionAccount', 'actionSection', 'actionSubsection'].forEach(id => { const s = document.getElementById(id); if (s.options.length > 0) s.selectedIndex = 0; }); }
        
        function populateFormDropdowns(accountEl, sectionEl, subsectionEl) {
            const a = document.getElementById(accountEl || 'actionAccount');
            a.innerHTML = '';
            const accounts = getCurrentStructure()?.accounts || [];
            accounts.forEach(acc => { const o = document.createElement('option'); o.value = acc.id; o.textContent = acc.name; a.appendChild(o); });
            
            const populateSectionsForDropdown = () => populateSections(accountEl, sectionEl, subsectionEl);
            populateSectionsForDropdown();
            a.onchange = populateSectionsForDropdown;
        }
        function populateSections(accountEl, sectionEl, subsectionEl) {
            const aId = document.getElementById(accountEl || 'actionAccount').value;
            const s = document.getElementById(sectionEl || 'actionSection');
            s.innerHTML = '<option value="">Aucune</option>';
            const account = getCurrentStructure()?.accounts.find(acc => acc.id === aId);
            if (account) { account.sections.forEach(sec => { const o = document.createElement('option'); o.value = sec.id; o.textContent = sec.name; s.appendChild(o); }); }
            
            const populateSubsectionsForDropdown = () => populateSubsections(accountEl, sectionEl, subsectionEl);
            populateSubsectionsForDropdown();
            s.onchange = populateSubsectionsForDropdown;
        }
        function populateSubsections(accountEl, sectionEl, subsectionEl) {
            const aId = document.getElementById(accountEl || 'actionAccount').value;
            const sId = document.getElementById(sectionEl || 'actionSection').value;
            const ss = document.getElementById(subsectionEl || 'actionSubsection');
            ss.innerHTML = '<option value="">Aucune</option>';
            if (sId) {
                const account = getCurrentStructure()?.accounts.find(acc => acc.id === aId);
                if (account) {
                    const section = account.sections.find(sec => sec.id === sId);
                    if (section) { section.subsections.forEach(sub => { const o = document.createElement('option'); o.value = sub.id; o.textContent = sub.name; ss.appendChild(o); }); }
                }
            }
        }
        
        function addAction() { 
            const n = document.getElementById('actionName').value;
            const a = document.getElementById('actionAccount').value;
            const s = document.getElementById('actionSection').value;
            const ss = document.getElementById('actionSubsection').value;
            const m = parseInt(document.getElementById('actionMonth').value);
            const amt = parseFloat(document.getElementById('actionAmount').value);
            const t = document.getElementById('actionType').value;
            
            if (!a || isNaN(amt)) return alert('Veuillez remplir les champs obligatoires : Compte et Montant.'); 
            
            if (appData.editingAction) {
                // --- MODE ÉDITION ---
                const originalAction = appData.years[appData.currentYear][appData.editingAction.type][appData.editingAction.id];

                // CORRIGÉ: Logique pour "promouvoir" une opération projetée en réelle
                if (originalAction && originalAction.autoGenerated && t === 'actual') {
                    // 1. Créer une nouvelle opération réelle à partir du formulaire
                    const newId = 'action_' + Date.now();
                    if (!appData.years[appData.currentYear]['actual']) { appData.years[appData.currentYear]['actual'] = {}; }
                    const newActualAction = { id: newId, name: n, account: a, section: s, subsection: ss, months: Array(12).fill(0) };
                    newActualAction.months[m] = amt;
                    appData.years[appData.currentYear]['actual'][newId] = newActualAction;

                    // 2. Supprimer l'instance mensuelle de l'opération projetée en mettant son montant à 0
                    originalAction.months[m] = 0;
                    
                    renderTable(); 
                    hideAddActionForm();
                    return; // Fin du traitement spécial
                }

                // Logique d'édition normale
                const originalType = appData.editingAction.type;
                const originalId = appData.editingAction.id;
                
                const transaction = appData.years[appData.currentYear][originalType][originalId];
                if (!transaction) { console.error("L'opération à modifier est introuvable."); hideAddActionForm(); return; }
                
                transaction.name = n;
                transaction.account = a;
                transaction.section = s;
                transaction.subsection = ss;
                transaction.months.fill(0);
                transaction.months[m] = amt;

                if (t !== originalType) {
                    if (!appData.years[appData.currentYear][t]) { appData.years[appData.currentYear][t] = {}; }
                    appData.years[appData.currentYear][t][originalId] = transaction;
                    delete appData.years[appData.currentYear][originalType][originalId];
                }
            } else { 
                // --- MODE AJOUT ---
                if (!appData.years[appData.currentYear][t]) { appData.years[appData.currentYear][t] = {}; }
                const id = 'action_' + Date.now(); 
                appData.years[appData.currentYear][t][id] = { id, name: n, account: a, section: s, subsection: ss, months: Array(12).fill(0) }; 
                appData.years[appData.currentYear][t][id].months[m] = amt; 
            }
            renderTable(); 
            hideAddActionForm();
        }

        function editAction(id, type) { 
            const a = appData.years[appData.currentYear][type][id]; if (!a) return; 
            if (a.isTransfer) { alert("Les virements ne peuvent pas être modifiés. Veuillez les supprimer et en créer un nouveau."); return; }
            
            showAddActionForm(); 
            document.getElementById('formTitle').textContent="Modifier l'Opération"; document.getElementById('addOrUpdateButton').textContent='Mettre à Jour'; 
            document.getElementById('deleteActionButton').style.display = a.autoGenerated ? 'none' : 'inline-block'; // On ne peut pas supprimer une instance auto, seulement la promouvoir
            
            let m = a.months.findIndex(v => v !== 0); if (m === -1) m = 0; 
            document.getElementById('actionName').value = a.name; document.getElementById('actionAccount').value = a.account; 
            populateFormDropdowns(); document.getElementById('actionSection').value = a.section || "";
            populateSubsections(); document.getElementById('actionSubsection').value = a.subsection || "";
            document.getElementById('actionMonth').value=m; document.getElementById('actionAmount').value=a.months[m]||0; 
            // CORRIGÉ: Si c'est une opération auto-générée, on propose par défaut de la passer en "Réel"
            document.getElementById('actionType').value = a.autoGenerated ? 'actual' : type; 
            appData.editingAction = {id, type};
        }

        function deleteAction() {
            if (!appData.editingAction) return;
            const { id, type } = appData.editingAction;
            const a = appData.years[appData.currentYear][type][id];
            if (a.isTransfer || a.autoGenerated) { alert("Cette opération ne peut être supprimée ici."); return; }
            if (confirm('Êtes-vous sûr(e) ?')) { 
                delete appData.years[appData.currentYear][type][id]; 
                renderTable(); hideAddActionForm(); 
            }
        }
        
        function showTransferModal() {
            const modal = document.getElementById('transferModal');
            document.getElementById('transferName').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferMonth').value = new Date().getMonth();
            populateTransferFormDropdowns();
            modal.style.display = 'block';
        }

        function populateTransferFormDropdowns() {
            const sourceSelect = document.getElementById('transferSourceAccount');
            const destSelect = document.getElementById('transferDestAccount');
            sourceSelect.innerHTML = '';
            destSelect.innerHTML = '';
            const accounts = getCurrentStructure()?.accounts || [];
            accounts.forEach(acc => {
                const o1 = document.createElement('option'); o1.value = acc.id; o1.textContent = acc.name; sourceSelect.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = acc.id; o2.textContent = acc.name; destSelect.appendChild(o2);
            });
        }
        function addTransfer() {
            const n=document.getElementById('transferName').value, src=document.getElementById('transferSourceAccount').value, dest=document.getElementById('transferDestAccount').value, m=parseInt(document.getElementById('transferMonth').value), amt=parseFloat(document.getElementById('transferAmount').value);
            if(src===dest)return alert("Les comptes doivent être différents.");
            if(isNaN(amt)||amt<=0)return alert("Veuillez entrer un montant valide.");
            ensureTransferSectionExists(src); ensureTransferSectionExists(dest);
            const baseId=`transfer_${Date.now()}`;
            const debit={id:`${baseId}_debit`,name:n||`Virement vers ${document.getElementById('transferDestAccount').options[document.getElementById('transferDestAccount').selectedIndex].text}`,account:src,section:VIREMENT_SECTION_ID,subsection:'',months:Array(12).fill(0),isTransfer:true};
            debit.months[m]=-amt;
            const credit={id:`${baseId}_credit`,name:n||`Virement depuis ${document.getElementById('transferSourceAccount').options[document.getElementById('transferSourceAccount').selectedIndex].text}`,account:dest,section:VIREMENT_SECTION_ID,subsection:'',months:Array(12).fill(0),isTransfer:true};
            credit.months[m]=amt;
            if(!appData.years[appData.currentYear]['actual'])appData.years[appData.currentYear]['actual']={};
            appData.years[appData.currentYear]['actual'][debit.id]=debit;
            appData.years[appData.currentYear]['actual'][credit.id]=credit;
            renderTable(); closeModal('transferModal'); alert('Virement effectué !');
        }
        function ensureTransferSectionExists(accountId) {
            const acc=getCurrentStructure().accounts.find(a=>a.id===accountId);
            if(acc&&!acc.sections.find(s=>s.id===VIREMENT_SECTION_ID))acc.sections.push({id:VIREMENT_SECTION_ID,name:VIREMENT_SECTION_NAME,subsections:[],budget:0});
        }

        // --- STATS MODAL ---
        function showStats() { const m=document.getElementById('statsModal'); m.querySelector('#stats-modal-title').textContent=`Statistiques pour ${appData.currentYear}`; m.querySelector('#statsContent').innerHTML=generateStatsContent(); m.style.display='block'; setTimeout(createCharts, 150); }
        
        function generateStatsContent() {
            // CORRIGÉ: Utilise uniquement les opérations réelles pour les statistiques
            const allActions = getActualActionsForCurrentYear();
            const structure = getCurrentStructure();
            
            const monthlyIncome = Array(12).fill(0);
            const monthlyExpenses = Array(12).fill(0);
            const monthlyBudgetTotal = Array(12).fill(0);
            const monthlyBudgetRemaining = Array(12).fill(0);
            const monthlyBiggestExpenseCategory = Array(12).fill('-');

            for (let i = 0; i < 12; i++) {
                const expensesInMonthByCategory = {};
                let monthTotalBudget = 0;
                let monthTotalExpense = 0;

                structure.accounts.forEach(account => {
                    account.sections.forEach(section => {
                        const isExpenseCategory = section.budget > 0;
                        if (isExpenseCategory) monthTotalBudget += section.budget;
                        section.subsections.forEach(subsection => {
                             if (subsection.budget > 0) monthTotalBudget += subsection.budget;
                        });
                    });
                });
                
                allActions.forEach(action => {
                    if (action.isTransfer) return;
                    const amount = action.months[i] || 0;
                    if (amount > 0) {
                        monthlyIncome[i] += amount;
                    } else if (amount < 0) {
                        const expenseAmount = Math.abs(amount);
                        monthlyExpenses[i] += expenseAmount;
                        monthTotalExpense += expenseAmount;
                        
                        const account = structure.accounts.find(acc => acc.id === action.account);
                        const section = account ? account.sections.find(sec => sec.id === action.section) : null;
                        const subsection = section ? section.subsections.find(sub => sub.id === action.subsection) : null;
                        let categoryName = section ? section.name : 'Non Catégorisé';
                        if (subsection) categoryName += ` > ${subsection.name}`;
                        expensesInMonthByCategory[categoryName] = (expensesInMonthByCategory[categoryName] || 0) + expenseAmount;
                    }
                });

                monthlyBudgetTotal[i] = monthTotalBudget;
                monthlyBudgetRemaining[i] = monthTotalBudget - monthTotalExpense;

                if (Object.keys(expensesInMonthByCategory).length > 0) {
                    let maxExpense = 0;
                    let maxCategoryName = '-';
                    for (const [category, total] of Object.entries(expensesInMonthByCategory)) {
                        if (total > maxExpense) {
                            maxExpense = total;
                            maxCategoryName = category;
                        }
                    }
                    monthlyBiggestExpenseCategory[i] = maxCategoryName;
                }
            }
            
            let tableHtml = `
                <div class="table-container" style="margin-bottom: 20px;">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Mois</th>
                                <th>Revenus</th>
                                <th>Dépenses</th>
                                <th>Différence</th>
                                <th>Statut Budget</th>
                                <th>Plus Grosse Dépense</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            for (let i = 0; i < 12; i++) {
                const difference = monthlyIncome[i] - monthlyExpenses[i];
                const diffClass = difference >= 0 ? 'amount-positive' : 'amount-negative';
                const budgetRemaining = monthlyBudgetRemaining[i];
                const budgetClass = budgetRemaining >= 0 ? 'amount-positive' : 'amount-negative';
                const budgetStatusText = monthlyBudgetTotal[i] > 0 
                    ? `${budgetRemaining.toFixed(2)}€`
                    : '<i>Aucun budget</i>';
                
                tableHtml += `
                    <tr>
                        <td><strong>${months[i]}</strong></td>
                        <td class="amount-positive">${monthlyIncome[i].toFixed(2)}€</td>
                        <td class="amount-negative">${monthlyExpenses[i].toFixed(2)}€</td>
                        <td class="${diffClass}">${difference.toFixed(2)}€</td>
                        <td class="budget-status ${budgetClass}">${budgetStatusText}</td>
                        <td class="category-name-cell">${monthlyBiggestExpenseCategory[i]}</td>
                    </tr>`;
            }

            tableHtml += '</tbody></table></div>';
            
            return `
                <div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="downloadStatsPNG()">🖼️ Télécharger l'Image</button></div>
                <div id="statsExportArea">
                    ${tableHtml}
                    <div class="chart-container"><h3>Aperçu du Solde Total</h3><canvas id="balanceOverviewChart"></canvas></div>
                    <div class="chart-container"><h3>Revenus vs Dépenses par Mois</h3><canvas id="incomeExpensesChart"></canvas></div>
                </div>`;
        }

        function createCharts() {
            // CORRIGÉ: Utilise uniquement les opérations réelles pour les graphiques
            const allActions = getActualActionsForCurrentYear();
            
            let totalBalanceData = Array(12).fill(0);
            const accounts = getCurrentStructure()?.accounts || [];
            accounts.forEach(account => {
                let monthlyNet = Array(12).fill(0); 
                allActions.forEach(a => { if (a.account === account.id) a.months.forEach((amt, i) => monthlyNet[i] += amt); });
                let cumulative = Array(12).fill(0); 
                cumulative[0] = getStartingBalance(account.id) + monthlyNet[0];
                for (let i = 1; i < 12; i++) { cumulative[i] = cumulative[i - 1] + monthlyNet[i]; }
                totalBalanceData.forEach((_, i) => totalBalanceData[i] += cumulative[i]);
            });
            const balCtx = document.getElementById('balanceOverviewChart'); 
            if (balCtx) { 
                const ex = Chart.getChart(balCtx); if (ex) ex.destroy(); 
                new Chart(balCtx, { type: 'line', data: { labels: months, datasets: [{ label: 'Solde Total', data: totalBalanceData, borderColor: '#F57C00', backgroundColor: 'rgba(245, 124, 0, 0.2)', tension: 0.4, fill: true }] }, options: { responsive: true, animation: false, scales: { y: { ticks: { callback: v => v.toFixed(0) + '€' } } } } }); 
            }

            const monthlyIncome = Array(12).fill(0);
            const monthlyExpensesBySection = {};
            const expenseSections = [];
            const structure = getCurrentStructure();
            if (structure) {
                structure.accounts.forEach(acc => {
                    acc.sections.forEach(sec => {
                        if (!expenseSections.find(s => s.id === sec.id)) { expenseSections.push({ id: sec.id, name: sec.name }); }
                    });
                });
            }
            expenseSections.push({ id: 'uncategorized', name: 'Non Catégorisé' });
            expenseSections.forEach(sec => { monthlyExpensesBySection[sec.id] = Array(12).fill(0); });
            
            allActions.forEach(a => {
                if (a.isTransfer) return;
                a.months.forEach((amt, i) => {
                    if (amt > 0) { monthlyIncome[i] += amt; } 
                    else if (amt < 0) {
                        const sectionId = a.section || 'uncategorized';
                        if (monthlyExpensesBySection[sectionId]) { monthlyExpensesBySection[sectionId][i] += Math.abs(amt); }
                    }
                });
            });

            const colorPalette = ['#EF5350', '#FFA726', '#5C6BC0', '#FF7043', '#8D6E63', '#EC407A', '#78909C', '#AB47BC'];
            const datasets = [];
            datasets.push({ label: 'Revenus', data: monthlyIncome, backgroundColor: '#81C784', stack: 'incomeStack' });
            let colorIndex = 0;
            expenseSections.forEach(sec => {
                const sectionTotal = monthlyExpensesBySection[sec.id].reduce((sum, val) => sum + val, 0);
                if (sectionTotal > 0) {
                    datasets.push({ label: sec.name, data: monthlyExpensesBySection[sec.id], backgroundColor: colorPalette[colorIndex % colorPalette.length], stack: 'expenseStack' });
                    colorIndex++;
                }
            });

            const incExpCtx = document.getElementById('incomeExpensesChart');
            if (incExpCtx) { 
                const ex = Chart.getChart(incExpCtx); if (ex) ex.destroy(); 
                new Chart(incExpCtx, { type: 'bar', data: { labels: months, datasets: datasets }, options: { responsive: true, animation: false, plugins: { tooltip: { callbacks: { footer: function(tooltipItems) { let total = 0; tooltipItems.forEach(function(tooltipItem) { if (tooltipItem.dataset.stack === 'expenseStack') { total += tooltipItem.parsed.y; } }); if (tooltipItems[0].dataset.stack === 'expenseStack') { return 'Total Dépenses: ' + total.toFixed(2) + '€'; } return ''; } } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { callback: v => v.toFixed(0) + '€' } } } } }); 
            }
        }
        function downloadStatsPNG() { const a=document.getElementById('statsExportArea');html2canvas(a,{backgroundColor:'#ffffff',scale:2}).then(c=>{const d=c.toDataURL('image/png');const e=document.createElement('a');e.href=d;e.download=`statistiques-${appData.currentYear}.png`;e.click();}); }
        
        // --- STRUCTURE & BUDGET MANAGEMENT ---
        function showStructureManager() { structureUiState.collapsed = {}; const m = document.getElementById('structureModal'); const c = document.getElementById('structureContent'); c.innerHTML = generateStructureContent(); m.style.display = 'block'; }
        function generateStructureContent() {
            let h = '<div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="addNewAccount()">+ Ajouter Compte</button></div>';
            const accounts = getCurrentStructure().accounts;
            accounts.forEach((account) => {
                h += `<div class="structure-item account">
                        <div class="structure-item-name"><span style="cursor: pointer;" onclick="toggleStructureAccountCollapse('${account.id}')"><strong>${structureUiState.collapsed[account.id] ? '▶' : '▼'} ${account.name}</strong></span></div>
                        <div class="structure-actions"><button class="btn btn-primary" onclick="addNewSection('${account.id}')">+ Section</button><button class="btn btn-warning" onclick="editAccount('${account.id}')">Modifier</button><button class="btn btn-danger" onclick="deleteAccount('${account.id}')">Supprimer</button></div>
                      </div>`;
                if (!structureUiState.collapsed[account.id]) {
                    account.sections.forEach((section) => {
                        h += `<div class="structure-item section">
                                <div class="structure-item-name"><span style="cursor: pointer;" onclick="toggleStructureSectionCollapse('${section.id}')">${structureUiState.collapsed[section.id] ? '▶' : '▼'} ${section.name}</span></div>
                                <div class="structure-actions"><label>Budget: <input type="number" class="budget-input" value="${section.budget || 0}" onchange="updateBudget('section', {accountId: '${account.id}', sectionId: '${section.id}'}, this.value)"></label><button class="btn btn-primary" onclick="addNewSubsection('${account.id}', '${section.id}')">+ Sous-section</button><button class="btn btn-warning" onclick="editSection('${account.id}', '${section.id}')">Modifier</button><button class="btn btn-danger" onclick="deleteSection('${account.id}', '${section.id}')">Supprimer</button></div>
                              </div>`;
                        if (!structureUiState.collapsed[section.id]) {
                            section.subsections.forEach((subsection) => {
                                h += `<div class="structure-item subsection">
                                        <div class="structure-item-name"><span>${subsection.name}</span></div>
                                        <div class="structure-actions"><label>Budget: <input type="number" class="budget-input" value="${subsection.budget || 0}" onchange="updateBudget('subsection', {accountId: '${account.id}', sectionId: '${section.id}', subsectionId: '${subsection.id}'}, this.value)"></label><button class="btn btn-warning" onclick="editSubsection('${account.id}', '${section.id}', '${subsection.id}')">Modifier</button><button class="btn btn-danger" onclick="deleteSubsection('${account.id}', '${section.id}', '${subsection.id}')">Supprimer</button></div>
                                      </div>`;
                            });
                        }
                    });
                }
            });
            return h;
        }

        function updateBudget(level, ids, value) {
            const val = parseFloat(value) || 0;
            const account = getCurrentStructure().accounts.find(a => a.id === ids.accountId);
            if (!account) return;
            if (level === 'section') {
                const section = account.sections.find(s => s.id === ids.sectionId);
                if (section) section.budget = val;
            } else if (level === 'subsection') {
                const section = account.sections.find(s => s.id === ids.sectionId);
                const subsection = section?.subsections.find(ss => ss.id === ids.subsectionId);
                if (subsection) subsection.budget = val;
            }
            renderTable();
        }

        function addNewAccount(){const n=prompt("Nom du nouveau compte:");if(n){const i='account_'+Date.now();getCurrentStructure().accounts.push({id:i,name:n,sections:[]});renderStructureAndAll();} }
        function addNewSection(aId){const n=prompt("Nom de la nouvelle section:");if(n){const a=getCurrentStructure().accounts.find(x=>x.id===aId);if(a){const i='section_'+Date.now();a.sections.push({id:i,name:n,subsections:[],budget:0});renderStructureAndAll();}}}
        function addNewSubsection(aId,sId){const e=prompt("Nom de la nouvelle sous-section:");if(e){const a=getCurrentStructure().accounts.find(x=>x.id===aId);if(a){const s=a.sections.find(x=>x.id===sId);if(s){const i='subsection_'+Date.now();s.subsections.push({id:i,name:e,budget:0});renderStructureAndAll();}}}}
        function editAccount(aId){const a=getCurrentStructure().accounts.find(x=>x.id===aId);if(!a)return;const e=prompt("Modifier le nom:",a.name);if(e&&e!==a.name){a.name=e;renderStructureAndAll();}}
        function editSection(aId,sId){const a=getCurrentStructure().accounts.find(x=>x.id===aId);if(!a)return;const s=a.sections.find(x=>x.id===sId);if(!s)return;const o=prompt("Modifier le nom:",s.name);if(o&&o!==s.name){s.name=o;renderStructureAndAll();}}
        function editSubsection(aId,sId,ssId){const a=getCurrentStructure().accounts.find(x=>x.id===aId);if(!a)return;const s=a.sections.find(x=>x.id===sId);if(!s)return;const ss=s.subsections.find(x=>x.id===ssId);if(!ss)return;const n=prompt("Modifier le nom:",ss.name);if(n&&n!==ss.name){ss.name=n;renderStructureAndAll();}}
        function deleteAccount(aId){if(confirm("Sûr? Ceci supprimera le compte et toutes ses données.")){const a=getCurrentStructure().accounts;const i=a.findIndex(x=>x.id===aId);if(i>-1){a.splice(i,1);renderStructureAndAll();}}}
        function deleteSection(aId,sId){if(confirm("Sûr? Ceci supprimera la section et ses données.")){const a=getCurrentStructure().accounts.find(x=>x.id===aId);if(a){const i=a.sections.findIndex(x=>x.id===sId);if(i>-1){a.sections.splice(i,1);renderStructureAndAll();}}}}
        function deleteSubsection(aId,sId,ssId){if(confirm("Sûr? Ceci supprimera la sous-section et ses données.")){const a=getCurrentStructure().accounts.find(x=>x.id===aId);if(a){const s=a.sections.find(x=>x.id===sId);if(s){const i=s.subsections.findIndex(x=>x.id===ssId);if(i>-1){s.subsections.splice(i,1);renderStructureAndAll();}}}}}
        
        // CORRIGÉ: Fonction helper pour rafraîchir la structure, la table ET les soldes initiaux
        function renderStructureAndAll() {
            document.getElementById('structureContent').innerHTML = generateStructureContent();
            populateFormDropdowns();
            renderTable();
            renderStartingBalances();
        }

        // --- RECURRENT TRANSACTIONS ---
        function showRecurrentModal() {
            const modal = document.getElementById('recurrentModal');
            populateFormDropdowns('recurrentAccount', 'recurrentSection', 'recurrentSubsection');
            renderRecurrentList();
            clearRecurrentForm();
            modal.style.display = 'block';
        }
        function renderRecurrentList() {
            const listDiv = document.getElementById('recurrentList');
            const transactions = appData.years[appData.currentYear]?.recurrentTransactions || [];
            if (transactions.length === 0) {
                listDiv.innerHTML = '<p>Aucune opération récurrente définie pour cette année.</p>';
                return;
            }
            let html = '<h3>Opérations Récurrentes Actives</h3>';
            transactions.forEach(t => {
                // CORRIGÉ: Affiche '(Sans nom)' si le nom est vide
                html += `<div class="structure-item">
                            <span><strong>${t.name || '(Sans nom)'}</strong> (${t.amount.toFixed(2)}€/mois)</span>
                            <div class="structure-actions">
                                <button class="btn btn-warning" onclick="editRecurrentTransaction('${t.id}')">Modifier</button>
                                <button class="btn btn-danger" onclick="deleteRecurrentTransaction('${t.id}')">Supprimer</button>
                            </div>
                         </div>`;
            });
            listDiv.innerHTML = html;
        }

        function saveRecurrentTransaction() {
            const name = document.getElementById('recurrentName').value;
            const amount = parseFloat(document.getElementById('recurrentAmount').value);
            // CORRIGÉ: Le nom n'est plus obligatoire
            if (isNaN(amount)) return alert("Veuillez renseigner un montant valide.");
            const transactionData = { name, amount, account: document.getElementById('recurrentAccount').value, section: document.getElementById('recurrentSection').value, subsection: document.getElementById('recurrentSubsection').value, startDate: document.getElementById('recurrentStartDate').value, endDate: document.getElementById('recurrentEndDate').value };
            const recurrentList = appData.years[appData.currentYear].recurrentTransactions;
            if (appData.editingRecurrent) {
                const index = recurrentList.findIndex(t => t.id === appData.editingRecurrent);
                if (index > -1) recurrentList[index] = { ...recurrentList[index], ...transactionData };
            } else {
                transactionData.id = 'recurrent_' + Date.now();
                recurrentList.push(transactionData);
            }
            clearRecurrentForm(); renderRecurrentList(); generateProjectedFromRecurrent(); renderTable();
        }
        
        function editRecurrentTransaction(id) {
            const t = appData.years[appData.currentYear].recurrentTransactions.find(trans => trans.id === id); if (!t) return;
            appData.editingRecurrent = id;
            document.getElementById('recurrentFormTitle').textContent = "Modifier l'Opération Récurrente";
            document.getElementById('addOrUpdateRecurrentButton').textContent = 'Mettre à Jour';
            document.getElementById('recurrentName').value = t.name;
            document.getElementById('recurrentAmount').value = t.amount;
            document.getElementById('recurrentAccount').value = t.account;
            populateSections('recurrentAccount', 'recurrentSection', 'recurrentSubsection'); document.getElementById('recurrentSection').value = t.section || '';
            populateSubsections('recurrentAccount', 'recurrentSection', 'recurrentSubsection'); document.getElementById('recurrentSubsection').value = t.subsection || '';
            document.getElementById('recurrentStartDate').value = t.startDate; document.getElementById('recurrentEndDate').value = t.endDate;
        }

        function deleteRecurrentTransaction(id) {
            if (confirm("Sûr de vouloir supprimer cette règle ? Les opérations déjà générées resteront.")) {
                const list = appData.years[appData.currentYear].recurrentTransactions;
                const index = list.findIndex(t => t.id === id);
                if (index > -1) { list.splice(index, 1); renderRecurrentList(); generateProjectedFromRecurrent(); renderTable(); }
            }
        }
        
        function clearRecurrentForm() {
            appData.editingRecurrent = null;
            document.getElementById('recurrentFormTitle').textContent = "Ajouter une Opération Récurrente";
            document.getElementById('addOrUpdateRecurrentButton').textContent = 'Ajouter';
            ['recurrentName', 'recurrentAmount', 'recurrentStartDate', 'recurrentEndDate'].forEach(id => document.getElementById(id).value = '');
        }

        function generateProjectedFromRecurrent() {
            const yearData = appData.years[appData.currentYear]; if (!yearData) return;
            if (yearData.projected) {
                Object.keys(yearData.projected).forEach(key => { if (yearData.projected[key].autoGenerated) delete yearData.projected[key]; });
            } else { yearData.projected = {}; }
            const recurrentList = yearData.recurrentTransactions || [];
            recurrentList.forEach(rule => {
                const start = rule.startDate ? new Date(rule.startDate + '-02T00:00:00') : null;
                const end = rule.endDate ? new Date(rule.endDate + '-02T00:00:00') : null;
                for (let i = 0; i < 12; i++) {
                    const monthDate = new Date(appData.currentYear, i, 15);
                    let isActive = true;
                    if (start && monthDate < start) isActive = false;
                    if (end && monthDate > end) isActive = false;
                    if (isActive) {
                        const id = `auto_${rule.id}_${i}`;
                        const newAction = { id, name: rule.name, account: rule.account, section: rule.section, subsection: rule.subsection, months: Array(12).fill(0), autoGenerated: true, recurrentSourceId: rule.id };
                        newAction.months[i] = rule.amount;
                        yearData.projected[id] = newAction;
                    }
                }
            });
        }
        
        // --- MODAL CONTROLS ---
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        window.onclick = function(event) { document.querySelectorAll('.modal').forEach(m => { if (event.target === m) m.style.display = 'none'; }); }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>